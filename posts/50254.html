<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><!-- 百度的html标记--><meta name="baidu-site-verification" content="codeva-bSLYjtWXtR"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>学成在线 | myl's blog</title><meta name="author" content="myl"><meta name="copyright" content="myl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学成在线视频：https://www.bilibili.com/video/BV1j8411N7Bm?p=1&amp;vd_source=1a39594354c31d775ddc587407a55282 文档：https://cyborg2077.github.io/2023/02/10/XuechengOnlinePart3/#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线">
<meta property="og:url" content="http://yileman.github.io/posts/50254.html">
<meta property="og:site_name" content="myl's blog">
<meta property="og:description" content="学成在线视频：https://www.bilibili.com/video/BV1j8411N7Bm?p=1&amp;vd_source=1a39594354c31d775ddc587407a55282 文档：https://cyborg2077.github.io/2023/02/10/XuechengOnlinePart3/#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover17.png">
<meta property="article:published_time" content="2024-03-06T00:00:00.000Z">
<meta property="article:modified_time" content="2024-04-07T03:42:01.000Z">
<meta property="article:author" content="myl">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover17.png"><link rel="shortcut icon" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/touxiang.jpg"><link rel="canonical" href="http://yileman.github.io/posts/50254.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="baidu-site-verification" content="codeva-bSLYjtWXtR"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '学成在线',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-07 11:42:01'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/user.css"><link rel="stylesheet" href="/css/rightMenu.css"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/gh/zhheo/Post-Abstract-AI@0.15.2/tianli_gpt.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://unpkg.com/hexo-butterfly-tag-plugins-plus-chinese@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/hexo-butterfly-tag-plugins-plus-chinese@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://unpkg.com/hexo-butterfly-tag-plugins-plus-chinese@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body><div id="loading-box"><div class="pokeball-back"></div><div class="pokeball-loading"><div class="pokeball" id="pokeball-normal"></div><div class="pokeball" id="pokeball-great"></div><div class="pokeball" id="pokeball-ultra"></div><div class="pokeball" id="pokeball-master"></div><div class="pokeball" id="pokeball-safari"></div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      //- console.log("end")
      $body.style.overflow = 'auto'

      document.getElementById('loading-box').style.transition = 'opacity 3s ease 0s'
      document.getElementById('loading-box').style.opacity = '0'
      setTimeout(function(){
        document.getElementById('loading-box').classList.add("loaded")
      }, 3000);

      //- $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.remove('loaded')
      
    }
  }

  preloader.initLoading()
  //- setTimeout(function(){preloader.endLoading();}, 3000);
  window.addEventListener('load',() => { preloader.endLoading() })
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fa fa-link"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover17.png')"><nav id="nav"><span id="blog-info"><a href="/" title="myl's blog"><span class="site-name">myl's blog</span></a></span><div id="menus"></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fa fa-link"></i><span> 留言板</span></a></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div id="randomPost"><a class="site-page social-icon search" href="javascript:;" onclick="randomPost()" title="随机访问一篇文章"><i class="fas fa-circle-notch fa-fw"></i></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-06T00:00:00.000Z" title="发表于 2024-03-06 08:00:00">2024-03-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-07T03:42:01.000Z" title="更新于 2024-04-07 11:42:01">2024-04-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98/">实战</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="学成在线"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover17.png');"></div><article class="post-content" id="article-container"><h1 id="学成在线"><a href="#学成在线" class="headerlink" title="学成在线"></a>学成在线</h1><p>视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1j8411N7Bm?p=1&amp;vd_source=1a39594354c31d775ddc587407a55282">https://www.bilibili.com/video/BV1j8411N7Bm?p=1&amp;vd_source=1a39594354c31d775ddc587407a55282</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://cyborg2077.github.io/2023/02/10/XuechengOnlinePart3/#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86">https://cyborg2077.github.io/2023/02/10/XuechengOnlinePart3/#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86</a></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240109141122521.png" alt="image-20240109141122521"></p>
<ul>
<li><p>用户层：描述了本系统所支持的用户类型包括：pc用户、app用户、h5用户。pc用户通过浏览器访问系统、app用户通过android、ios手机访问系统，H5用户通过h5页面访问系统。</p>
</li>
<li><p>CDN：全称Content Delivery Network，即内容分发网络，本系统所有静态资源全部通过CDN加速来提高访问速度。系统静态资源包括：html页面、js文件、css文件、image图片、pdf和ppt及doc教学文档、video视频等。</p>
</li>
<li>系统的CDN层、UI层、服务层及数据层均设置了负载均衡服务，上图仅在UI层前边标注了负载均衡。 每一层的负载均衡会根据系统的需求来确定负载均衡器的类型，系统支持4层负载均衡+7层负载均衡结合的方式，4层负载均衡是指在网络传输层进行流程转发，根据IP和端口进行转发，7层负载均衡完成HTTP协议负载均衡及反向代理的功能，根据url进行请求转发</li>
<li>UI层：描述了系统向pc用户、app用户、h5用户提供的产品界面。根据系统功能模块特点确定了UI层包括如下产品界面类型： 1）面向pc用户的门户系统、学习中心系统、教学管理系统、系统管理中心。 2）面向h5用户的门户系统、学习中心系统。 3）面向app用户的门户系统、学习中心系统。</li>
<li>微服务层将系统服务分类三类：业务服务、基础服务、第三方代理服务。 业务服务：主要为学成在线核心业务提供服务，并与数据层进行交互获得数据。 基础服务：主要管理学成在线系统运行所需的配置、日志、任务调度、短信等系统级别的服务。 第三方代理服务：系统接入第三方服务完成业务的对接，例如认证、支付、视频点播/直播、用户认证和授权。</li>
<li>数据层描述了系统的数据存储的内容类型，关系性数据库：持久化的业务数据使用MySQL。 消息队列：存储系统服务间通信的消息，本身提供消息存取服务，与微服务层的系统服务连接。 索引库：存储课程信息的索引信息，本身提供索引维护及搜索的服务，与微服务层的系统服务连接。 缓存：作为系统的缓存服务，作为微服务的缓存数据便于查询。 文件存储：提供系统静态资源文件的分布式存储服务，文件存储服务器作为CDN服务器的数据来源，CDN上的静态资源将最终在文件存储服务器上保存多份。</li>
</ul>
<ul>
<li><p>工程结构</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240109142156626.png" alt="image-20240109142156626"></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240109143211283.png" alt="image-20240109143211283"></p>
</li>
<li><p>数据模型</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240109142833380.png" alt="image-20240109142833380"></p>
</li>
<li><p>什么时候用vo什么时候用dto</p>
<ul>
<li><p>多个前端调用接口的时候</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240109151832346.png" alt="image-20240109151832346"></p>
</li>
<li><p>前端调接口 ：VO/DTO</p>
</li>
<li><p>接口调业务：DTO</p>
</li>
<li><p>业务调数据：PO</p>
</li>
</ul>
</li>
<li><p>swagger</p>
<ul>
<li><p>xuecheng-plus-content-api导入依赖</p>
</li>
<li><p>bootstrap.yml</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">swagger:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">"学成在线内容管理系统"</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">"内容系统管理系统对课程相关信息进行管理"</span></span><br><span class="line">  <span class="attr">base-package:</span> <span class="string">com.xuecheng.content</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动类开启注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableSwagger2Doc</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>访问:<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html">http://localhost:63040/content/swagger-ui.html</a></p>
</li>
<li><p>升级为knife4j</p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:63040/content/doc.html">http://localhost:63040/content/doc.html</a></p>
</li>
</ul>
</li>
<li><p>数据字典表：用于对应前端的响应</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240110151549125.png" alt="image-20240110151549125"></p>
</li>
<li><p>httpclient</p>
<ul>
<li><p><code>.http文件</code>，类似于postman，swagger，但是可以保存测试数据且是idea自带</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240110160051703.png" alt="image-20240110160051703"></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240110160107352.png" alt="image-20240110160107352"></p>
</li>
</ul>
</li>
<li><p>前端工程运行：看readme文件</p>
</li>
<li><p>JRS303校验</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>然后在po、dto等类的字段上加注解如 <code>@NotEmpty</code></li>
<li>最后在controller调用的时候给形参加注解<code>@validated</code></li>
</ul>
</li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240111093212987.png" alt="image-20240111093212987"></p>
<ul>
<li>JRS303分组校验<ul>
<li>多个接口用一个模型类</li>
</ul>
</li>
</ul>
<h3 id="0-总结"><a href="#0-总结" class="headerlink" title="0 总结"></a>0 总结</h3><h4 id="1-异常处理"><a href="#1-异常处理" class="headerlink" title="1 异常处理"></a>1 异常处理</h4><ul>
<li><p><code>@ControllerAdvice</code>与<code>@ExceptionHandler</code>用来捕获异常</p>
</li>
<li><p><code>@ResponseStatus</code>用来确定响应数据</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240303152434784.png" alt="image-20240303152434784"></p>
</li>
</ul>
<h4 id="2-传入数据判断是否为空方法"><a href="#2-传入数据判断是否为空方法" class="headerlink" title="2 传入数据判断是否为空方法"></a>2 传入数据判断是否为空方法</h4><ul>
<li><p>在controller方法内部手动判断：<code>StringUtils.isNotEmpty</code></p>
</li>
<li><p>实体类的数据上标注<code>@NotNull</code>，然后在controller中的形参前面加上<code>@Valid</code>注解，再在全局异常中添加<code>BindException</code>异常类的捕获</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240303153429684.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240303153429684.png</a>“ alt=”image-20240303153429684” style=”zoom:50%;” /&gt;</p>
</li>
</ul>
<h4 id="3-controller与前端的数据传递"><a href="#3-controller与前端的数据传递" class="headerlink" title="3 controller与前端的数据传递"></a>3 controller与前端的数据传递</h4><ul>
<li>形参不带注解：此时参数名称一定要和请求参数的名称一致<ul>
<li>get方式提交，直接写参数</li>
<li>通过<code>HttpServletRequest</code>接收：<code>request.getParameter("username")</code></li>
<li>通过java类对象接收</li>
</ul>
</li>
<li>形参带注解<ul>
<li><code>@RequestParam</code>：有value、require、defaultValue字段可填充</li>
<li><code>@PathVariable</code>：支持类似于：<code>user/get/mac/{macAddress}</code>的请求</li>
<li><code>@ModelAttribute("user")</code>:会将客户端传递过来的参数按名称注入到指定对象中，并且会将这个对象自动加入ModelMap中，便于View层使用</li>
</ul>
</li>
</ul>
<h4 id="4-树形查询"><a href="#4-树形查询" class="headerlink" title="4 树形查询"></a>4 树形查询</h4><ul>
<li><p><code>left join</code>连接表（可以是相同的表）</p>
</li>
<li><p>指定<code>resultMap</code>为一个值，然后再在指定的<code>resultMap</code>中设置映射关系并将结果返回。</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240303160733160.png" alt="image-20240303160733160"></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240303160740937.png" alt="image-20240303160740937"></p>
</li>
</ul>
<h4 id="5-视频分块上传"><a href="#5-视频分块上传" class="headerlink" title="5 视频分块上传"></a>5 视频分块上传</h4><ul>
<li><code>RandomAccessFile</code>实现文件的分块和合并</li>
<li>判断是否一致 ==&gt; <code>DigestUtils.md5Hex()</code></li>
</ul>
<h4 id="6-Transactional"><a href="#6-Transactional" class="headerlink" title="6 @Transactional"></a>6 @Transactional</h4><ul>
<li><p>自调用的时候需要声明一个代理对象来方便进行事务的管理</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304110055984.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304110055984.png</a>“ alt=”image-20240304110055984” style=”zoom:67%;” /&gt;</p>
</li>
<li><p><code>@Transactional</code>即声明式事务管理， 建立在AOP之上的。其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，在执行完目标方法之后根据执行情况提交或者回滚事务。</p>
</li>
</ul>
<h4 id="7-freemarker"><a href="#7-freemarker" class="headerlink" title="7 freemarker"></a>7 freemarker</h4><ul>
<li><p>controller中返回<code>ModelAndView</code>对象，在<code>setViewName</code>中设置重定向的页面文件，在<code>addObject</code>中传值</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304142757986.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304142757986.png</a>“ alt=”image-20240304142757986” style=”zoom:80%;” /&gt;</p>
</li>
</ul>
<h4 id="8-xxj-job"><a href="#8-xxj-job" class="headerlink" title="8 xxj-job"></a>8 xxj-job</h4><ul>
<li>获取执行器序号、 执行器总数，然后用表的<code>id % 总数 == 序号</code>来保证一个任务只会被一个执行器执行，用字段标识来保证一个任务只会被执行一次(乐观锁)</li>
<li>用于视频转码作业</li>
<li>课程发布操作后，先更新数据库中的课程发布状态，更新后向Redis、ElasticSearch、MinIO写课程信息，只要在一定时间内最终成功写入数据即可<ul>
<li>这里使用了feign远程调用，在向MinIO写信息的时候调用了Media服务的相关接口<ul>
<li>熔断降级：返回null对象，然后再去判断是否为null来判断是否发生了故障</li>
<li>注意启动类开启注解<code>@EnableFeignClients</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="9-ES"><a href="#9-ES" class="headerlink" title="9 ES"></a>9 ES</h4><ul>
<li><p>倒排索引过程</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304153213090.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304153213090.png</a>“ alt=”image-20240304153213090” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>概念</p>
<ul>
<li>文档：一条完整的数据，包括索引、名称等，以json方式存储</li>
<li>字段：文档中的具体字段，类似于表格的列</li>
<li>索引：就是相同类型的文档的集合，类似于表。eg：用户的索引、商品的索引、订单的索引…</li>
<li>映射(mapping)：索引中字段的约束信息，类似于表的结构约束。</li>
</ul>
</li>
<li><p>安装ik分词器</p>
</li>
<li><p>索引库的操作</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304154138185.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304154138185.png</a>“ alt=”image-20240304154138185” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>文档的操作</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304154206085.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304154206085.png</a>“ alt=”image-20240304154206085” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>搜索结果处理</p>
<ul>
<li>排序</li>
<li>分页</li>
<li>高亮<ul>
<li>给文档中的所有关键字都添加一个标签，例如<code>&lt;em&gt;</code>标签</li>
<li>页面给<code>&lt;em&gt;</code>标签编写CSS样式</li>
</ul>
</li>
</ul>
</li>
<li><p>demo</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testMatchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">// 1. 准备Request对象，对应 GET /hotel/_search</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">"hotel"</span>);</span><br><span class="line">    <span class="comment">// 2. 组织DSL参数 对应 "query": {"match_all": {}}</span></span><br><span class="line">    request.source().query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">// 3. 发送请求，得到相应结果</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    创建SearchRequest对象，指定索引库名</span></span><br><span class="line"><span class="comment">    利用request.source()构建DSL，DSL中可以包含查询、分页、排序、高亮等</span></span><br><span class="line"><span class="comment">    利用client.search()发送请求，得到响应</span></span><br><span class="line"><span class="comment">关键API：    </span></span><br><span class="line"><span class="comment">    一个是request.source()，其中包含了query、order、from、size、highlight等所有功能</span></span><br><span class="line"><span class="comment">    另一个是QueryBuilders，其中包含了match、term、function_score、bool等各种查询</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>数据聚合：用来实现对数据的统计分析计算等</p>
</li>
</ul>
<h4 id="10-Spring-Security"><a href="#10-Spring-Security" class="headerlink" title="10 Spring Security"></a>10 Spring Security</h4><ul>
<li><p>继承<code>UserDetailsService</code>接口，重写<code>loadUserByUsername()</code>方法</p>
<ul>
<li><p>返回<code>UserDetails</code>对象</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240305102255518.png" alt="image-20240305102255518"></p>
</li>
</ul>
</li>
<li><p><code>DaoAuthenticationProviderCustom extends DaoAuthenticationProvider</code></p>
<ul>
<li>刚刚我们重写的<code>loadUserByUsername()</code>方法是由<code>DaoAuthenticationProvider</code>调用的</li>
<li>重写<code>additionalAuthenticationChecks()</code>里面会比对密码，但不是所有的登录方式都有密码</li>
<li>然后在<code>WebSecurityConfig extends WebSecurityConfigurerAdapter</code>中配置刚刚定义的 <code>DaoAuthenticationProvider</code></li>
</ul>
</li>
<li><p>OAuth2.0</p>
<ul>
<li>客户端请求资源拥有者授权</li>
<li>资源拥有者授权客户端，即用户授权目标网站访问自己的用户信息</li>
<li>目标网站携带授权码请求认证</li>
<li>认证通过，颁发令牌</li>
<li>目标网站携带令牌请求资源服务器，获取资源</li>
<li>资源服务器校验令牌通过后，提供受保护的资源</li>
</ul>
</li>
<li><p>JWT：</p>
<ul>
<li>好处：在认证服务颁发令牌给客户端后，客户端携带令牌请求其他服务的资源时，其他服务可以直接校验令牌合法性，无需再经过认证服务。</li>
<li>缺点：JWT令牌占用空间较大</li>
<li>无状态认证：用户身份信息存储在令牌中，服务端从JWT解析出用户信息</li>
<li>有状态认证：用户信息通过session存储在服务端</li>
<li>组成<ul>
<li>头部Header：令牌类型及使用的哈希算法</li>
<li>负载Payload：用户信息</li>
<li>签名Sugbature：根据密钥进行加密前两部分，防止篡改</li>
</ul>
</li>
</ul>
</li>
<li><p><code>SecurityContextHolder</code>获取当前访问的用户信息：<code>Authentication</code>对象</p>
<ul>
<li>原理：<code>ThreadLocal</code></li>
</ul>
</li>
<li><p>用户授权</p>
<ul>
<li>授权认证服务器<code>@EnableAuthorizationServer</code> ==&gt; 配置资源列表：<code>xuecheng-plus</code></li>
<li>资源服务器<code>@EnableResourceServer</code> ==&gt; 定义资源id：<code>xuecheng-plus</code></li>
<li>接口添加<code>@PreAuthorize("hasAuthority('权限标识符')")</code>即可</li>
<li>授权定义在<code>loadUserByUsername</code>方法中返回的<code>UserDetails</code>中，是一个<code>String</code>类型的数组</li>
<li>没有权限抛出<code>AccessDeniedException</code>在全局异常处理器中捕获即可</li>
</ul>
</li>
</ul>
<h4 id="11-验证码"><a href="#11-验证码" class="headerlink" title="11 验证码"></a>11 验证码</h4><ul>
<li><code>Kaptcha</code> </li>
</ul>
<h4 id="12-RabbitMQ"><a href="#12-RabbitMQ" class="headerlink" title="12 RabbitMQ"></a>12 RabbitMQ</h4><ul>
<li><p>异步通讯</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240306162652779.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240306162652779.png</a>“ alt=”image-20240306162652779” style=”zoom:67%;” /&gt;</p>
</li>
<li></li>
</ul>
<h2 id="0-坑"><a href="#0-坑" class="headerlink" title="0 坑"></a>0 坑</h2><h4 id="1-StringUtils"><a href="#1-StringUtils" class="headerlink" title="1 StringUtils"></a>1 <code>StringUtils</code></h4><ul>
<li>StringUtils.isNotEmpty</li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240110155057659.png" alt="image-20240110155057659"></p>
<ul>
<li>会去掉<code>null</code>和<code>""</code>两种情况，所以比 <code>... != null</code>好</li>
</ul>
<h4 id="2-跨域请求问题"><a href="#2-跨域请求问题" class="headerlink" title="2 跨域请求问题"></a>2 跨域请求问题</h4><ul>
<li><p>从一个地址请求到另一个地址：协议、端口、主机三者有一个不一致就属于跨域</p>
<ul>
<li>端口的跨域</li>
<li>主机的跨域</li>
<li>协议的跨域：<code>http</code>和<code>https</code></li>
</ul>
</li>
<li><p>解决一：利用script跨域跨域的特性解决</p>
</li>
<li><p>解决二：服务端添加响应头</p>
<ul>
<li><p>服务端收到请求判断这个origin是否允许跨域，如果允许则在响应头中说明允许该来源的跨域请求：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin:http//localhost:8601</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>允许任何域名来源跨域</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin:*</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>定义一个<code>GlobalCorsConfig</code>类</p>
</li>
</ul>
</li>
<li><p>解决三：通过nginx代理跨域</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240110165247455.png" alt="image-20240110165247455"></p>
</li>
</ul>
<h4 id="3-开热点会占用端口！"><a href="#3-开热点会占用端口！" class="headerlink" title="3 开热点会占用端口！"></a>3 开热点会占用端口！</h4><h4 id="4-maven-3-6-1"><a href="#4-maven-3-6-1" class="headerlink" title="4 maven 3.6.1"></a>4 maven 3.6.1</h4><ul>
<li>maven版本对项目也是有影响的</li>
</ul>
<h4 id="5-nginx"><a href="#5-nginx" class="headerlink" title="5 nginx"></a>5 nginx</h4><ul>
<li><p>设置最大上传文件大小，默认是1M</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304144704820.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240304144704820.png</a>“ alt=”image-20240304144704820” style=”zoom:67%;” /&gt;</p>
</li>
</ul>
<h2 id="1-nacos"><a href="#1-nacos" class="headerlink" title="1 nacos"></a>1 nacos</h2><ul>
<li>Spring Cloud：一套规范</li>
<li>Spring Cloud alibaba：nacos服务注册中心、配置中心</li>
</ul>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>namespace：用于区分环境，比如开发环境、测试环境、生产环境</li>
<li>group：用于区分项目</li>
</ul>
<h3 id="实现nacos上报服务步骤"><a href="#实现nacos上报服务步骤" class="headerlink" title="实现nacos上报服务步骤"></a>实现nacos上报服务步骤</h3><ul>
<li><p>启动虚拟机，然后启动docker容器</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></tbody></table></figure>
<p>随后访问<a href="http://192.168.71.22:8848即可">http://192.168.71.22:8848即可</a></p>
</li>
<li><p>在父工程上添加<code>spring-cloud-alibaba-dependencies</code>依赖</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114103338764.png" alt="image-20240114103338764"></p>
</li>
<li><p>在子模块上添加依赖用于上报信息（谁需要启动就上报谁）</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114103739675.png" alt="image-20240114103739675"></p>
</li>
<li><p>在子模块的配置文件中配置nacos信息</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114104508191.png" alt="image-20240114104508191"></p>
</li>
<li><p>坑</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114125029189.png" alt="image-20240114125029189"></p>
</li>
</ul>
<h3 id="实现nacos配置中心"><a href="#实现nacos配置中心" class="headerlink" title="实现nacos配置中心"></a>实现nacos配置中心</h3><ul>
<li><p>好处：不用重启就可以修改配置、多服务的时候配置集中</p>
</li>
<li><p>配置分类</p>
<ul>
<li>项目特有的配置</li>
<li>公共的配置</li>
</ul>
</li>
<li><p>nacos如何定位一个具体的配置文件</p>
<ul>
<li><p>通过namespace、group找到具体的环境和具体的项目</p>
</li>
<li><p>通过dataid找到具体的配置文件，dataid组成</p>
<ul>
<li><p><code>(content-setrvice)-(dev).(yaml)</code>：<code>服务名-环境名.yaml</code></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114125655369.png" alt="image-20240114125655369"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>在nacos中创建好配置</p>
<ul>
<li><p>根据上述起：dataid，以及group</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114131013547.png" alt="image-20240114131013547"></p>
</li>
<li><p>随后写入配置并发布</p>
</li>
</ul>
</li>
<li><p>服务中引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>坑</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--不引入这个依赖会报错找不到类：com.alibaba.nacos.client.logging.NacosLogging--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.nacos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--不引入这个依赖会报错找不到类：com/alibaba/spring/util/PropertySourcesUtils--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.spring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>配置扩展：读取别的配置信息</p>
<ul>
<li>在content-api中配置引入content-service的配置</li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114135844607.png" alt="image-20240114135844607"></p>
</li>
<li><p>公共配置：读取公共配置信息</p>
<ul>
<li>在nacos中分别创建<code>swagger-dev.yaml</code>与<code>loggin-dev.yaml</code>均属于<code>xuecheng-plus-common</code>组</li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114140720353.png" alt="image-20240114140720353"></p>
</li>
<li><p>优先级</p>
<ul>
<li>项目应用名配置文件&gt;扩展配置文件&gt;共享配置文件&gt;本地配置文件 </li>
</ul>
</li>
<li><p>如何让本地优先？（场景：本地想多端口启动同一个服务）</p>
<ul>
<li><p>修改远程配置文件</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114141638717.png" alt="image-20240114141638717"></p>
</li>
<li><p>然后启动的时候添加VM参数：</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240114141706783.png" alt="image-20240114141706783"></p>
</li>
</ul>
</li>
</ul>
<h2 id="2-分布式文件系统"><a href="#2-分布式文件系统" class="headerlink" title="2 分布式文件系统"></a>2 分布式文件系统</h2><ul>
<li><p>将若干计算机通过网络连接共同提供文件存储服务</p>
</li>
<li><p>NFS</p>
</li>
<li>GFS</li>
<li>HDFS</li>
<li><p>云计算厂家</p>
<ul>
<li>阿里云对象存储服务(OSS)</li>
</ul>
</li>
<li><p>MinIO</p>
<ul>
<li>使用了纠删码技术</li>
<li><a target="_blank" rel="noopener" href="https://www.minio.org.cn/">https://www.minio.org.cn/</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.minio.org.cn/docs/">https://www.minio.org.cn/docs/</a> </li>
</ul>
</li>
</ul>
<h2 id="3-媒资管理服务"><a href="#3-媒资管理服务" class="headerlink" title="3 媒资管理服务"></a>3 媒资管理服务</h2><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115131858362.png" alt="image-20240115131858362"></p>
<h3 id="3-1-上传图片（MinIO）"><a href="#3-1-上传图片（MinIO）" class="headerlink" title="3.1 上传图片（MinIO）"></a>3.1 上传图片（MinIO）</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115132057535.png" alt="image-20240115132057535"></p>
<ul>
<li>前端进入上传图片界面</li>
<li>上传图片，请求媒资管理服务</li>
<li>媒资管理服务将图片文件存储在MinIO</li>
<li>媒资管理记录文件信息到数据库</li>
<li>保存课程信息，在内容管理数据库保存图片地址</li>
</ul>
<h3 id="3-2-上传视频（断点续传）"><a href="#3-2-上传视频（断点续传）" class="headerlink" title="3.2 上传视频（断点续传）"></a>3.2 上传视频（断点续传）</h3><ul>
<li><p>断点续传：将上传和下载功能分为多个部分，防止中途断网导致的重新下载和上传文件</p>
</li>
<li><p>实现：文件分块</p>
<ul>
<li><p>前端上传前先把文件分成块</p>
</li>
<li><p>一块一块的上传，上传中断后重新上传。已上传的分块则不用再上传</p>
</li>
<li><p>各分块上传完成后，在服务端合并文件</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115152036661.png" alt="image-20240115152036661"></p>
</li>
</ul>
</li>
<li><p>具体流程</p>
<ol>
<li>前端上传文件前，请求媒资接口层检查文件是否存在<ul>
<li>若存在，则不再上传</li>
<li>若不存在，则开始上传，首先对视频文件进行分块</li>
</ul>
</li>
<li>前端分块进行上传，上传前首先检查分块是否已经存在<ul>
<li>若分块已存在，则不再上传</li>
<li>若分块不存在，则开始上传分块</li>
</ul>
</li>
<li>前端请求媒资管理接口层，请求上传分块</li>
<li>接口层请求服务层上传分块</li>
<li>服务端将分块信息上传到MinIO</li>
<li>前端将分块上传完毕，请求接口层合并分块</li>
<li>接口层请求服务层合并分块</li>
<li>服务层根据文件信息找到MinIO中的分块文件，下载到本地临时目录，将所有分块下载完毕后开始合并</li>
<li>合并完成后，将合并后的文件上传至MinIO</li>
</ol>
</li>
<li><p>相关问题</p>
</li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115211313009.png" alt="image-20240115211313009"></p>
<h3 id="3-3-视频转码（XXL-JOB）"><a href="#3-3-视频转码（XXL-JOB）" class="headerlink" title="3.3 视频转码（XXL-JOB）"></a>3.3 视频转码（XXL-JOB）</h3><ul>
<li><p>转换视频编码</p>
<ul>
<li><p>ffmpeg：转码工具</p>
</li>
<li><p>目标：<code>.avi</code>转<code>.mp4</code></p>
</li>
</ul>
</li>
</ul>
<h4 id="分布式任务处理"><a href="#分布式任务处理" class="headerlink" title="分布式任务处理"></a>分布式任务处理</h4><ul>
<li>视频上传成功需要对视频格式进行处理，如何用Java程序对视频进行处理呢？<ul>
<li>这里有一个关键的需求就是：当视频比较多的时候，我们如何高效的处理</li>
</ul>
</li>
<li>如何去高效的处理一批任务呢？<ul>
<li>多线程<ul>
<li>多线程是充分利用单机的资源</li>
</ul>
</li>
<li>分布式+多线程<ul>
<li>充分利用多台计算机，每台计算机使用多线程处理</li>
</ul>
</li>
</ul>
</li>
<li>方案2的可扩展性更强，同时方案二也是一种分布式任务调度的处理方案</li>
</ul>
<ul>
<li>JDK也为我们提供了相关支持，如Timer、ScheduledExecutor<ul>
<li>缺点是不能胜任复杂的任务</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    timer.schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="comment">//<span class="doctag">TODO:</span> something</span></span><br><span class="line">        }</span><br><span class="line">    }, <span class="number">1000</span>, <span class="number">2000</span>); <span class="comment">// 1秒后开始调度，每2秒执行一次</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    service.scheduleAtFixedRate(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                <span class="comment">//<span class="doctag">TODO:</span> something</span></span><br><span class="line">                System.out.println(<span class="string">"todo something"</span>);</span><br><span class="line">            }</span><br><span class="line">        }, <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>Quartz</code>: Quartz设计的核心类包括Job，Trigger以及Scheduler。</p>
<ul>
<li>Job负责定义需要执行的任务</li>
<li>Trigger负责设置调度策略</li>
<li>Scheduler将二者组装在一起，并触发任务开始执行</li>
</ul>
</li>
</ul>
<h4 id="XXL-Job"><a href="#XXL-Job" class="headerlink" title="XXL-Job"></a>XXL-Job</h4><ul>
<li><p><code>XXL-JOB</code>:是一个轻量级分布式任务调度平台，其核心设计是开发迅速、学习简单、轻量级、易扩展，现已开放源代码并接入多家公司线上产品线，开箱即用</p>
</li>
<li><p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
</li>
<li><p>组成：调度中心、执行器、任务</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115213145999.png" alt="image-20240115213145999"></p>
<ul>
<li>调度中心<ul>
<li>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码</li>
<li>主要职责为执行器管理、任务管理、监控运维、日志管理等</li>
</ul>
</li>
<li>任务执行器<ul>
<li>负责接收调度请求并执行任务逻辑</li>
<li>主要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</li>
</ul>
</li>
<li>任务<ul>
<li>负责执行具体的业务逻辑</li>
</ul>
</li>
</ul>
</li>
<li><p>执行流程</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115213223020.png" alt="image-20240115213223020"></p>
<ol>
<li>任务执行器根据配置的调度中心的地址，自动注册到调度中心</li>
<li>达到任务出发条件，调度中心下发任务</li>
<li>执行器基于线程池执行任务，并把执行结果放入内存队列、把执行日志写入日志文件中</li>
<li>执行器消费内存队列中的执行结果，主动上报给调度中心</li>
<li>当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</li>
</ol>
</li>
<li><p>XXL-job部署</p>
<ul>
<li><p>首先下载XXL-JOB</p>
<ul>
<li>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></li>
<li>GitEE：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></li>
<li>项目使用2.3.1版本： <a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></li>
</ul>
</li>
<li><p>使用IDEA打开项目</p>
<ul>
<li>xxl-job-admin：调度中心</li>
<li>xxl-job-core：公共依赖</li>
<li>xxj-job-executor-samples：执行器Sample示例<ul>
<li>xxl-job-executor-sample-springboot：SpringBoot版本，通过SpringBoot管理执行器</li>
<li>xxl-job-executor-sample-frameless：无框架版本</li>
</ul>
</li>
</ul>
</li>
<li><p>根据数据库脚本创建数据库，修改数据库连接信息和端口，启动xxl-job-admin，访问<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin/toLogin">http://localhost:8080/xxl-job-admin/toLogin</a></p>
<ul>
<li>账号密码：admin/123456</li>
</ul>
</li>
<li><p>启动成功之后，可以选择在Linux上运行</p>
<ul>
<li><p>使用maven命令，将xxl-job-admin打包，然后将其上传至Linux中，使用命令启动</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -jar /绝对路径/xxl-job-admin-2.3.1.jar &amp;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>执行器注册</p>
<ul>
<li><p>在网页上新建一个执行器</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115214339070.png" alt="image-20240115214339070"></p>
</li>
<li><p>在媒资服务中添加依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在nacos中配置</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115214547214.png" alt="image-20240115214547214"></p>
</li>
<li><p>将示例工程下的配置类<code>XxlJobConfig</code> 拷贝到media-service工程下，该类中的属性就是获取配置文件中的配置得到的，同时提供了一个执行器的Bean</p>
</li>
</ul>
</li>
<li><p>执行任务</p>
<ul>
<li><p>拷贝<code>SampleXxlJob</code>到media-service项目的service/jobhandler包中</p>
</li>
<li><p>在调度中心注册任务</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115220351208.png" alt="image-20240115220351208"></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115220414563.png" alt="image-20240115220414563"></p>
</li>
<li><p>最后在调度中心开启任务</p>
</li>
<li>调度中心的高级配置说明<ul>
<li>路由策略:有多个执行器的时候，选择让谁来执行，<ul>
<li>```<ul>
<li>FIRST（第一个）：固定选择第一个机器；<pre><code>  - LAST（最后一个）：固定选择最后一个机器；
  - ROUND（轮询）：；
  - RANDOM（随机）：随机选择在线的机器；
  - CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。
  - LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；
  - LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；
  - FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；
  - BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；
  - SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；
</code></pre><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">    - 子任务id：执行完这个任务后再执行的任务id</span><br><span class="line">    - 调度过期策略：</span><br><span class="line">    - 阻塞过期策略：</span><br><span class="line">    - 任务超时时间</span><br><span class="line">    - 失败重试次数</span><br><span class="line"></span><br><span class="line">- 分片广播</span><br><span class="line"></span><br><span class="line">  ![image-20240115221446082](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240115221446082.png)</span><br><span class="line"></span><br><span class="line">  - 场景：</span><br><span class="line">    - 分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍</span><br><span class="line">    - 广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等</span><br><span class="line">  - 所以广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群的分布式处理任务</span><br><span class="line"></span><br><span class="line">#### 作业分片方案</span><br><span class="line"></span><br><span class="line">- 任务添加成功后，对于要处理的任务，会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，此时如何保证多个执行器不会重复执行任务？</span><br><span class="line"></span><br><span class="line">  - 每个执行器收到广播任务有两个参数，**分片序号**和**分片总数**。每个执行器从数据表取任务时，可以用`任务id`对`分片总数`取`模`，如果等于该执行器的分片序号，则执行此任务</span><br><span class="line"></span><br><span class="line">  ![image-20240116094226494](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116094226494.png)</span><br><span class="line"></span><br><span class="line">#### 保证任务不重复执行</span><br><span class="line"></span><br><span class="line">- 通过作业分片方案，保证了执行器之间分配的任务不重复执行</span><br><span class="line"></span><br><span class="line">  - 但是如果同一个执行器，在处理一个视频的时候，还没有处理完，此时调度中心又来了一次请求调度，为了不重复处理同一个视频，该怎么办？</span><br><span class="line"></span><br><span class="line">- 配置调度过期策略</span><br><span class="line"></span><br><span class="line">  ![image-20240116094341299](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116094341299.png)</span><br><span class="line"></span><br><span class="line">  - 选择忽略</span><br><span class="line"></span><br><span class="line">- 配置阻塞处理策略：就是当前执行器正在执行任务还没有结束时，调度中心又请求调度，此时该如何处理</span><br><span class="line"></span><br><span class="line">  ![image-20240116094429676](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116094429676.png)</span><br><span class="line"></span><br><span class="line">  - 选择`丢弃后续调度`，避免重复调度</span><br><span class="line"></span><br><span class="line">- 最后是保证任务的幂等性：对于数据的操作不论多少次，操作的结果始终是一致的。</span><br><span class="line">  - 执行器接收调度请求去执行任务，要有办法去判断该任务是否处理完成，如果处理完则不再处理，即使重复调度处理相同的任务也不能重复处理相同的视频。</span><br><span class="line">  - 幂等性的常用方案</span><br><span class="line">    - 数据库约束，例如：唯一索引、主键</span><br><span class="line">    - 乐观锁，长用户数据库，更新数据时根据乐观锁状态去更新</span><br><span class="line">    - 唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等，则执行</span><br><span class="line">  - 这里我们在数据库视频处理表中**添加状态处理字段**，视频处理完成**更新状态为完成**，执行视频前判断状态是否完成，如果完成则不再处理</span><br><span class="line"></span><br><span class="line">#### 业务流程</span><br><span class="line"></span><br><span class="line">- 确定了分片方案，下面梳理视频上传以及处理的业务流程</span><br><span class="line"></span><br><span class="line">  ![image-20240116095127790](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116095127790.png)</span><br><span class="line"></span><br><span class="line">- 上传视频成功，向视频待处理表中添加记录，视频处理的详细流程如下</span><br><span class="line"></span><br><span class="line">  ![image-20240116094658382](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116094658382.png)</span><br><span class="line"></span><br><span class="line">  - 任务调度中心广播作业分片</span><br><span class="line"></span><br><span class="line">  - 执行器收到广播作业分片，从数据库读取待处理任务</span><br><span class="line"></span><br><span class="line">    ![image-20240116094821777](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116094821777.png)</span><br><span class="line"></span><br><span class="line">  - 执行器根据任务内容MinIO下载要处理的文件</span><br><span class="line"></span><br><span class="line">  - 执行器启动多线程去处理任务</span><br><span class="line"></span><br><span class="line">  - 任务处理完成，上传处理后的视频到MinIO</span><br><span class="line"></span><br><span class="line">  - 将更新任务处理结果，如果视频处理完成，除了更新任务处理结果之外，还要将文件的访问地址更新至任务处理表及文件中，最后将任务完成记录写入历史表</span><br><span class="line"></span><br><span class="line">#### 分布式锁</span><br><span class="line"></span><br><span class="line">- 为了保证任务不重复执行，需要加锁</span><br><span class="line"></span><br><span class="line">- 如果是多个执行器分布式部署，不能保证同一个视频只有一个执行器处理。现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图:</span><br><span class="line"></span><br><span class="line">  ![image-20240116104845403](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116104845403.png)</span><br><span class="line"></span><br><span class="line">- 虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务</span><br><span class="line">- 该锁不属于某个虚拟机，而是分布式部署，由多个虚拟机共享，这种锁叫**分布式锁**</span><br><span class="line">- 实现</span><br><span class="line">  - 基于数据库：利用数据库主键唯一的特点（**本次实现**）</span><br><span class="line">  - 基于redis：redis提供了分布式锁的实现方案，比如SETNX </span><br><span class="line">    - SETNX是去set一个不存在的key。多个线程设置同一个key只会有一个线程设置成功，设置成功的拿到锁</span><br><span class="line">  - 基于zookeeper：多线程向zookeeper创建一个子目录，只会有一个创建成功，谁创建成功谁拿到锁</span><br><span class="line"></span><br><span class="line">#### 面试tip</span><br><span class="line"></span><br><span class="line">- ![image-20240116142001860](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116142001860.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- ![image-20240116142334028](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116142334028.png)</span><br><span class="line"></span><br><span class="line">- ![image-20240116142518301](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116142518301.png)</span><br><span class="line"></span><br><span class="line">### 3.4 绑定媒资</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 4 课程发布模块</span><br><span class="line"></span><br><span class="line">![image-20240116145059489](https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116145059489.png)</span><br><span class="line"></span><br><span class="line">### 4.1 课程预览</span><br><span class="line"></span><br><span class="line">1. 教学机构用户在课程管理中可对该机构所管理的课程进行检索</span><br><span class="line">2. 点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面</span><br><span class="line">3. 点即课程目录中的具体章节，查看视频是否正常播放</span><br><span class="line"></span><br><span class="line">#### java模板引擎</span><br><span class="line"></span><br><span class="line">- 根据前面的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致，保证了教学机构人员发布前看到的是什么样，发布后也会看到什么样</span><br><span class="line"></span><br><span class="line">- 所以模板引擎就是`模板 + 数据 = 输出`。JSP页面就是模板，页面中嵌入的JSP标签就是数据，两者相结合输出HTML网页</span><br><span class="line">- 常用的Java模板引擎还有那些？</span><br><span class="line">  - JSP</span><br><span class="line">  - **Freemarker**:本项目采用</span><br><span class="line">  - Thymeleaf</span><br><span class="line">  - Velocity</span><br><span class="line"></span><br><span class="line">#### Freemarker</span><br><span class="line"></span><br><span class="line">- 引入依赖</span><br><span class="line"></span><br><span class="line">  ```xml</span><br><span class="line">  &lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-freemarker&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>nacos中的配置</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span>   <span class="comment">#关闭模板缓存，方便测试</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">template_update_delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span>   <span class="comment">#页面模板后缀名</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/templates/</span>   <span class="comment">#页面模板位置(默认为 classpath:/templates/)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>并在contente-api的resource目录下创建templates目录</li>
</ul>
</li>
<li><p>在contente-api的配置文件中引入nacos中远程配置</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116145803347.png" alt="image-20240116145803347"></p>
</li>
<li><p>添加模板,在resource下创建templates目录（与配置文件中一致），添加test.ftl模板文件</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Hello ${broski}!</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Controller中添加方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/testfreemaker")</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.setViewName(<span class="string">"test"</span>);</span><br><span class="line">    modelAndView.addObject(<span class="string">"broski"</span>, <span class="string">"Kyle"</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动内容管理服务，访问<a target="_blank" rel="noopener" href="http://localhost:53040/content/testfreemaker">http://localhost:53040/content/testfreemaker</a> ，屏幕输出<code>Hello Kyle!</code></p>
</li>
</ul>
<h4 id="部署门户网站"><a href="#部署门户网站" class="headerlink" title="部署门户网站"></a>部署门户网站</h4><h4 id="文件服务及视频播放"><a href="#文件服务及视频播放" class="headerlink" title="文件服务及视频播放"></a>文件服务及视频播放</h4><ul>
<li>见<a target="_blank" rel="noopener" href="https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8">https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8</a></li>
</ul>
<h4 id="加入nginx"><a href="#加入nginx" class="headerlink" title="加入nginx"></a>加入nginx</h4><p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116203422988.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116203422988.png</a>“ alt=”image-20240116203422988” style=”zoom:50%;” /&gt;</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240116200235703.png" alt="image-20240116200235703"></p>
<h4 id="修改host"><a href="#修改host" class="headerlink" title="修改host"></a>修改host</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn group.51xuecheng.cn group1.xuecheng.com localhost</span><br></pre></td></tr></tbody></table></figure>
<h4 id="编写freemarker模板"><a href="#编写freemarker模板" class="headerlink" title="编写freemarker模板"></a>编写freemarker模板</h4><ul>
<li>文档：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></li>
</ul>
<h3 id="4-2-课程审核"><a href="#4-2-课程审核" class="headerlink" title="4.2 课程审核"></a>4.2 课程审核</h3><ol>
<li>学机构提交课程审核后，平台运营人员登录运营平台查询待审核的记录</li>
<li>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容</li>
<li>如果存在问题，则审核不通过，并附上审核不通过的原因供教学机构人员查看</li>
<li>如果课程内容没有违规信息且课程内容全面，则审核通过</li>
<li><p>课程审核通过后，教学机构发布课程成功</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117100848288.png" alt="image-20240117100848288"></p>
</li>
</ol>
<ul>
<li><p>课程状态转移</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117101213845.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117101213845.png</a>“ alt=”image-20240117101213845” style=”zoom:67%;” /&gt;</p>
</li>
</ul>
<ul>
<li>状态说明<ul>
<li>一门课程新增后，它的审核状态为<code>未提交</code>，发布状态为<code>未发布</code></li>
<li>课程信息编辑完成，教学机构人员进行<code>提交审核</code>操作，此时课程的审核状态为<code>已提交</code></li>
<li>当课程状态为<code>已提交</code>时，运营平台人员对课程进行审核</li>
<li>运营平台人员审核课程，结果有两个：审核通过、审核不通过</li>
<li>课程审核后不管状态是否通过，教学机构都可以再次修改课程并提交审核，此时课程状态为<code>已提交</code>，运营平台人员再次审核课程</li>
<li>课程审核通过，教学机构人员可以发布课程，发布成功后，课程的发布状态为<code>已发布</code></li>
<li>课程发布后，通过<code>下架</code>操作可以更改课程发布状态为<code>下架</code></li>
<li>课程下架后，通过<code>上架</code>操作可以再次发布课程，上架后课程发布状态为<code>发布</code></li>
</ul>
</li>
</ul>
<ul>
<li><p>问题：课程审核通过后再修改，运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时就可能产生冲突，例如：运营人员正在审核时，教学机构把数据修改了</p>
<ul>
<li>为了解决这个问题，我们专门设计了一张课程与发布表<ul>
<li>提交课程审核，将课程基本信息、营销信息、课程计划汇总后，写入该表中。</li>
<li>课程审核人员从预发布表查询信息</li>
<li>课程审核通过执行课程发布，将课程预发布的信息写入课程发布表</li>
<li>提交审核课程后，必须等待课程审核完毕后，才可以再次提交课程（无论审核通过/不通过）</li>
</ul>
</li>
</ul>
</li>
<li><p>业务中的数据转移</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117103008531.png" alt="image-20240117103008531"></p>
</li>
</ul>
<h3 id="4-3-课程发布"><a href="#4-3-课程发布" class="headerlink" title="4.3 课程发布"></a>4.3 课程发布</h3><ol>
<li>教学机构用户在课程管理中可对机构内课程进行检索</li>
<li>点击某课程数据后的发布连接，即可对该课程进行发布</li>
<li>课程发布后可通过课程搜索查询到的课程信息，查看课程的详细信息</li>
<li>点击课程搜索页中课程列表的某个课程，可以进入课程详情页</li>
</ol>
<ul>
<li><p>教学机构人员在课程审核通过后，即可发布课程，课程发布后会公开展示在网站上供学生查看、选课、学习</p>
<ul>
<li>如何去快速搜索课程？打开课程详情页面仍然去查询数据库可行吗？</li>
</ul>
</li>
<li><p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117110214188.png" alt="image-20240117110214188"></p>
</li>
<li><p>操作</p>
<ul>
<li>向内容管理数据库的课程发布并存储课程发布信息</li>
<li>向Redis存储课程缓存信息</li>
<li>向Elasticsearch存储课程索引信息</li>
<li>请求分布式文件系统存储存储课程静态化页面（即htm页面），实现快速浏览课程详情页面</li>
</ul>
</li>
<li><p>问题：一次课程发布操作需要向数据库、Redis、Elasticsearch、MinIO写四份数据，这里存在<strong>分布式事务问题</strong></p>
</li>
</ul>
<h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h4><ul>
<li>本地事务：平时我们在程序中通过Spring去控制事务是利用数据库本身的事务特性来实现的，因此叫<code>数据库事务</code>，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为<strong>本地事务</strong>。<ul>
<li>本地事务具有ACID四大特性<ul>
<li>原子性（Atomicity）：事务是一个不可分割的工作单位，事务中的操作要么全部成功，要么全部失败。</li>
<li>一致性（Consistency）：事务在执行前后必须保持数据的一致性，即满足业务逻辑和约束条件。</li>
<li>隔离性（Isolation）：事务之间不应相互干扰，每个事务都应该在独立的环境中执行，不受其他事务的影响。</li>
<li>持久性（Durability）：事务一旦提交，其对数据的修改就应该永久保存在数据库中，即使发生系统故障或崩溃也不会丢失。</li>
</ul>
</li>
</ul>
</li>
<li><p>现在的需求是：课程发布操作后，将数据写入数据库、Redis、ElasticSearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，而是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性（例如突然断网），在这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务，称之为<strong>分布式事务</strong></p>
</li>
<li><p><strong>CAP理论</strong>是一个分布式系统设计的重要理论，它指出一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项。</p>
<ul>
<li>一致性是指所有节点访问同一份最新的数据副本</li>
<li>可用性是指每个请求都能得到响应</li>
<li>分区容忍性是指系统能够在网络分区的情况下继续运行。</li>
</ul>
</li>
<li>所以CAP中要么保证CP要么保证AP</li>
<li>CP的场景：满足C舍弃A，强调一致性<ul>
<li>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败，另一方执行回滚操作</li>
<li>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败，该用户都不可使用新开账户，要满足一致性</li>
</ul>
</li>
<li>AP的场景：满足A舍弃C，强调可用性(<strong>较多</strong>)<ul>
<li>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可</li>
<li>注册送积分，注册成功，积分在24小时内到账</li>
<li>支付短信通信，支付成功发短信，短信发送可以有延迟</li>
</ul>
</li>
<li><strong>BASE理论</strong>：基于AP，是Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写<ul>
<li>基本可用：当系统无法满足全部可用时，保证核心业务可用即可，比如一个外卖系统，到了饭点的时候系统并发量很高，此时要保证下单流程涉及的服务可用，其他服务暂不可用</li>
<li>软状态：可以存在中间状态，例如：微博的评论功能。当用户发表一条评论时，这条评论并不会立即同步到所有关注者的页面上，而是会先存储在缓存中，并逐渐传播到其他节点。这样就存在了一个中间状态，即某些用户可以看到这条评论，而某些用户还不能看到。</li>
<li>最终一致性：前面的软状态并不影响微博的整体可用性，用户仍然可以正常浏览和发表微博。最终，在一定时间内，所有关注者都能看到这条评论，达到了最终一致性。</li>
</ul>
</li>
</ul>
<h4 id="课程发布"><a href="#课程发布" class="headerlink" title="课程发布"></a>课程发布</h4><ul>
<li><p>课程发布的分布式事务控制：使用AP</p>
<ul>
<li><p>课程发布操作后，先更新数据库中的课程发布状态，更新后向Redis、ElasticSearch、MinIO写课程信息，只要在一定时间内最终成功写入数据即可</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117113008428.png" alt="image-20240117113008428"></p>
<ol>
<li>在内容管理服务的数据库添加一个消息表（mq_message），消息表和课程发布表在同一个数据库</li>
<li>点击课程发布，通过本地事务向课程发布表写入课程发布信息，同时向消息表写入课程发布的信息，这两条记录需保证同时存在或者同时不存在</li>
<li>启动任务调度系统的定时调度，内容管理服务去定时扫描消息表的记录</li>
<li>当扫描到课程发布的消息时，即开始向Redis、ElasticSearch、MinIO完成同步数据的操作</li>
<li>同步数据的任务完成后删除消息表记录，并插入历史消息表</li>
</ol>
</li>
</ul>
</li>
<li><p>时序图</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117113120291.png" alt="image-20240117113120291"></p>
</li>
</ul>
<h4 id="消息处理SDK"><a href="#消息处理SDK" class="headerlink" title="消息处理SDK"></a>消息处理SDK</h4><ul>
<li>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？<ul>
<li>增删改查</li>
</ul>
</li>
<li>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117120836198.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117120836198.png</a>“ alt=”image-20240117120836198” style=”zoom:60%;” /&gt;</li>
</ul>
<ul>
<li><p>问题：如果在每个地方都实现一套针对消息定时扫描、处理的逻辑，基本上都是重复的，软件的复用性太低、成本太高</p>
</li>
<li><p>解决：将消息处理相关的逻辑做成一个通用的东西，将消息处理做成一个SDK工具包，相比较通用服务，不仅可以解决将消息处理通用化的需求，还可以降低成本</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117120935111.png" alt="image-20240117120935111"></p>
</li>
<li><blockquote>
<p> 执行任务应该是SDK包含的功能吗？</p>
</blockquote>
<ul>
<li>拿课程发布任务举例，执行课程发布任务是要向Redis、索引库等同步数据，其他任务的执行逻辑是不同的，所以执行任务在SDK中不用实现，只需要提供一个抽象方法由具体的执行任务方去实现</li>
</ul>
</li>
<li><blockquote>
<p>如何保证任务的幂等性？</p>
</blockquote>
<ul>
<li>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案<ul>
<li>任务执行完成后，从消息表删除</li>
<li>如果消息表的状态是完成或不存在，则无需执行</li>
</ul>
</li>
</ul>
</li>
<li><blockquote>
<p>如何保证任务不重复执行？</p>
</blockquote>
<ul>
<li>任务调度采用分片广播，根据分片参数去获取处理任务，配置调度过期策略为<code>忽略</code>，配置任务阻塞处理策略为<code>丢弃后续调度</code></li>
</ul>
</li>
<li><blockquote>
<p>根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，但是如果一个任务旗下又分为好几个小任务，例如课程发布任务需要执行3个同步操作：存储课程到Redis、存储课程到索引库、存储课程页面到MinIO。如果其中一个小任务已经完成，也不应该去重复执行这个小任务，那么该如何设计呢？</p>
</blockquote>
<ul>
<li>将小任务作为任务的不同阶段，在消息表中设立阶段状态</li>
<li>每完成一个阶段，就在对应的阶段状态字段打上标记，即使大任务还没有完成，重新执行大任务时，也会跳过执行完毕了的小任务</li>
<li>这里设立更多个小任务阶段状态字段为冗余字段，以备不时之需（万一你一个大任务下有10个小任务呢）</li>
<li>不过这里4个小任务状态字段就够了</li>
</ul>
</li>
</ul>
<h4 id="页面静态化"><a href="#页面静态化" class="headerlink" title="页面静态化"></a>页面静态化</h4><ul>
<li>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统</li>
</ul>
<blockquote>
<p>什么是页面静态化？</p>
</blockquote>
<ul>
<li>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面。这个过程是当客户端请求服务器时，服务器才开始渲染生成html页面，最终响应给浏览器，这个过程支持并发是有限的</li>
<li>页面静态化则强调将生成的html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时，直接请求html页面，由于是静态页面，可以使用nginx、apache等高性能web服务器，并发性能高</li>
</ul>
<blockquote>
<p>什么时候能用页面静态化技术？</p>
</blockquote>
<ul>
<li>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。</li>
<li>因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大</li>
<li>根据课程发布的也无需求，虽然课程发布后仍可以修改课程信息，但是需要经过课程审核，且修改频率不高，所以适合使用页面静态化</li>
</ul>
<h4 id="feign远程调用"><a href="#feign远程调用" class="headerlink" title="feign远程调用"></a>feign远程调用</h4><ul>
<li><p>content-service添加feign依赖</p>
</li>
<li><p>nacos中配置feign并在content-service配置文件中引入</p>
</li>
<li><p>编写<code>MultipartSupportConfig</code>类使feign支持<code>Mulipart</code></p>
</li>
<li><p>编写feign接口</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165530100.png" alt="image-20240117165530100"></p>
</li>
<li><p>启动类添加<code>@EnableFeignClients</code>注解</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165545746.png" alt="image-20240117165545746"></p>
</li>
<li><p>测试</p>
</li>
</ul>
<h4 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h4><ul>
<li><p>当微服务运行不正常，会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理，可能会导致雪崩效应</p>
</li>
<li><p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务时，可能导致其他服务也挂掉。</p>
<ul>
<li><p>例如服务C调用服务B，服务B调用服务A，由于服务A异常导致服务B响应缓慢，最终导致服务A和服务B都不可用，而服务B不可用又导致服务C也不可用。</p>
</li>
<li><p>像这样由一个服务所引起的一连串的服务都无法提供服务，就是微服务的雪崩效应</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165655380.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165655380.png</a>“ alt=”image-20240117165655380” style=”zoom:50%;” /&gt;</p>
</li>
</ul>
</li>
<li><blockquote>
<p>如何解决由于微服务异常所引起的雪崩效应呢？</p>
</blockquote>
<ul>
<li>采用<strong>熔断、降级</strong>的方法去解决</li>
</ul>
</li>
<li><p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系</p>
<ul>
<li><p><strong>熔断</strong>：当下游服务异常时，断开与上游服务的交互。它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响</p>
</li>
<li><p><strong>降级</strong>：当下游服务异常触发熔断后，上游服务就不再去调用异常的服务，而是执行降级处理逻辑，这个降级处理逻辑可以是本地的一个单独的方法</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165816743.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165816743.png</a>“ alt=”image-20240117165816743” style=”zoom: 50%;” /&gt;</p>
</li>
<li><p>而这都是为了保护系统，熔断是当下服务异常时一种保护系统的手段，<strong>降级是熔断后上游服务处理熔断的方法</strong></p>
</li>
</ul>
</li>
<li><p>具体处理</p>
<ol>
<li><p>开启feign熔断保护，在feign-dev.yaml中配置</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240117165914647.png" alt="image-20240117165914647"></p>
</li>
<li><p>定义降级逻辑</p>
<ul>
<li>方式一：<strong>fallback</strong>。定义一个fallback类<code>MediaServiceClientFallback</code>，此类实现了<code>MediaServiceClient</code>接口</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 媒资管理服务远程调用接口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@FeignClient(value = "media-api", configuration = MultipartSupportConfig.class, fallback = MediaServiceClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> {</span><br><span class="line">    <span class="meta">@RequestMapping(value = "/media/upload/coursefile", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("filedata")</span> MultipartFile upload,</span></span><br><span class="line"><span class="params">                <span class="meta">@RequestParam(value = "folder", required = false)</span> String folder,</span></span><br><span class="line"><span class="params">                <span class="meta">@RequestParam(value = "objectName", required = false)</span> String objectName)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaServiceClientFallback</span> <span class="keyword">implements</span> <span class="title class_">MediaServiceClient</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(MultipartFile upload, String folder, String objectName)</span> {</span><br><span class="line">        log.debug(<span class="string">"方式一：熔断处理，无法获取异常"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>缺点：无法获取熔断的异常信息</p>
<ul>
<li>方式二：<strong>fallbackFactory</strong>。由于方式一无法取出熔断所抛出的异常，而方式二定义MediaServiceClientFallbackFactory可以解决这个问题</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 媒资管理服务远程调用接口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@FeignClient(value = "media-api", configuration = MultipartSupportConfig.class, fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> {</span><br><span class="line">    <span class="meta">@RequestMapping(value = "/media/upload/coursefile", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("filedata")</span> MultipartFile upload,</span></span><br><span class="line"><span class="params">                <span class="meta">@RequestParam(value = "folder", required = false)</span> String folder,</span></span><br><span class="line"><span class="params">                <span class="meta">@RequestParam(value = "objectName", required = false)</span> String objectName)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;MediaServiceClient&gt; {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MediaServiceClient</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(MultipartFile upload, String folder, String objectName)</span> {</span><br><span class="line">                log.debug(<span class="string">"方式二：熔断处理，熔断异常：{}"</span>, throwable.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>定义降级逻辑</p>
<ul>
<li>返回一个null对象，上游服务请求接口得到一个null，说明执行了降级处理</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="4-4-课程搜索"><a href="#4-4-课程搜索" class="headerlink" title="4.4 课程搜索"></a>4.4 课程搜索</h3><h4 id="es"><a href="#es" class="headerlink" title="es"></a>es</h4><p>参考文档：<a target="_blank" rel="noopener" href="https://cyborg2077.github.io/2022/12/24/ElasticSearch/#RestAPI">https://cyborg2077.github.io/2022/12/24/ElasticSearch/#RestAPI</a></p>
<p>主要过程</p>
<ul>
<li><p>linux启动es，kibana（可视化管理）</p>
</li>
<li><p>创建mapping（类似于一个表，声明了有哪些列及属性）</p>
</li>
<li>转移到java项目中</li>
<li>初始化<code>RestHighLevelClient</code><ul>
<li>引入依赖</li>
<li>初始化RestHighLevelClient的Bean</li>
<li>使用</li>
</ul>
</li>
</ul>
<blockquote>
<p> RestHighLevelClient</p>
<ul>
<li>文档操作：<code>XxxIndexRequest</code>，Xxx是<code>Create、Get、Delete</code></li>
<li>文档搜索：Search API</li>
<li><code>QueryBuilder</code>用于构造搜索条件</li>
</ul>
</blockquote>
<h4 id="课程信息索引同步"><a href="#课程信息索引同步" class="headerlink" title="课程信息索引同步"></a>课程信息索引同步</h4><ul>
<li>方案<ul>
<li>Canal（实时性高）</li>
<li>消息队列（实时性不高）</li>
<li><strong>定时任务调度（xxlJob）</strong></li>
</ul>
</li>
<li>流程<ul>
<li>课程发布向消息表中插入记录</li>
<li>由任务调度程序通过消息处理SDK对消息记录进行处理</li>
<li>向es索引中保存课程信息</li>
</ul>
</li>
</ul>
<h2 id="5-认证授权模块"><a href="#5-认证授权模块" class="headerlink" title="5 认证授权模块"></a>5 认证授权模块</h2><h3 id="5-1-准备"><a href="#5-1-准备" class="headerlink" title="5.1 准备"></a>5.1 准备</h3><ul>
<li>认证授权模块实现平台所有用户的身份认证和用户授权功能</li>
</ul>
<blockquote>
<p>什么是用户身份认证？</p>
<ul>
<li>用户身份认证即当用户访问系统资源时，系统要求验证用户的身份信息，身份合法方可继续访问</li>
<li>常见的用户身份认证表现形式有<ul>
<li>用户名密码登录</li>
<li>微信扫码登录等</li>
</ul>
</li>
</ul>
<p>什么是用户授权？</p>
<ul>
<li>用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。</li>
<li>例如用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限<ul>
<li>如果没有权限，则拒绝继续访问系统</li>
<li>如果有权限，则继续发布课程</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li><p>统一认证</p>
<ul>
<li><p>包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118153738021.png" alt="image-20240118153738021"></p>
</li>
<li><p>认证通过由认证服务想用户颁发令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源</p>
</li>
</ul>
</li>
<li><p>单点登录</p>
<ul>
<li>本项目基于微服务架构构建，微服务包括：内容管理服务、媒资管理服务、系统管理服务等。</li>
<li>为了提高用户的体验性，用户只需要依次认证，便可以在多个拥有访问权限的系统中访问，这个功能叫<strong>单点登录</strong></li>
<li>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</li>
</ul>
</li>
<li><p>第三方认证</p>
<ul>
<li><p>为了提高用户体验，很多网站都具有扫码登录的功能，例如微信扫码登录、QQ扫码登录等</p>
</li>
<li><p>扫码登录的好处是用户不用输入账号密码，操作简便，而且有利于用户信息的共享。</p>
</li>
<li><p>互联网的优势就是资源共享，用户也是一种资源，对于一个新网站，如果让用户去注册是很困难的，如果提供了微信扫码登录，将省去用户的注册成本，是一种非常有效的推广方式。</p>
</li>
<li><p>微信扫码登录其中的原理正是使用了第三方认证，如下图</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118153940987.png" alt="image-20240118153940987"></p>
</li>
</ul>
</li>
</ul>
<h4 id="Spring-Security认证"><a href="#Spring-Security认证" class="headerlink" title="Spring Security认证"></a>Spring Security认证</h4><ul>
<li><p>认证功能几乎是每个项目都要具备的功能，并且它与业务无关，市面上有很多认证框架，如Apache Shiro、CAS、<strong>Spring Security</strong>等</p>
</li>
<li><p>本项目是基于Spring Cloud技术构建，Spring Security是spring家族的一份子，且和Spring Cloud集成的很好，所以本项目采用Spring Security作为认证服务的技术框架</p>
</li>
<li><p>项目主页：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>
</li>
<li><p>SpringCloud Security：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-security">https://spring.io/projects/spring-cloud-security</a></p>
</li>
<li><p><code>Spring Security</code>功能的实现主要是由一系列过滤器链相互配合完成的</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118165200653.png" alt="image-20240118165200653"></p>
<ul>
<li><code>SecurityContextPresistenceFilter</code>：这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的SecurityContextRepository中获取SecurityContext，然后把它设置给SecurityContextHolder，在请求完成后，将SecurityContextRepository持有的SecurityContext再保存到配置好的SecurityContextRepository，同时清楚SecurityContextHolder所持有的SecurityContext</li>
<li><code>UsernamePasswordAuthenticationFilter</code>：用于处理来自表单提交的认证，该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的AuthenticationSuccessHandler和AuthenticationFailureHandler，这些都可以根据需求做相关改变</li>
<li><code>FilterSecurityInterceptor</code>是用于保护web资源的，使用<code>AccessDecisionManager</code>对当前用户进行授权访问</li>
<li><code>ExeptionTranslationFilter</code>能够捕获来自<code>FilterChain</code>所有的异常，并进行处理。但是他只会处理两类异常：<code>AuthenticationException</code>和<code>AccessDeniedException</code>，其他的异常它会继续抛出</li>
</ul>
</li>
<li><p>执行流程</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118164818741.png" alt="image-20240118164818741"></p>
</li>
</ul>
<h4 id="OAuth2协议"><a href="#OAuth2协议" class="headerlink" title="OAuth2协议"></a>OAuth2协议</h4><ul>
<li><p>前面我们提到的微信扫码认证，是一种第三方认证方式，这种认证方式是基于OAuth2协议实现的</p>
</li>
<li><p>OAuth2认证微信扫码登录的过程</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118165833884.png" alt="image-20240118165833884"></p>
</li>
<li><p>具体流程如下</p>
<ul>
<li>用户点击微信扫码登录，微信扫码的目的是通过微信认证登录目标网站，目标网站需要从微信获取当前用户的身份信息才会让当前用户在目标网站登录成功<ul>
<li>首先搞清楚几个概念<ul>
<li><code>资源</code>：用户信息，在微信中存储</li>
<li><code>资源拥有者</code>：用户是用户信息资源的拥有者</li>
<li><code>认证服务</code>：微信负责认证当前用户的身份，负责为客户端颁发令牌</li>
<li><code>客户端</code>：客户端会携带令牌请求微信获取用户信息</li>
</ul>
</li>
</ul>
</li>
<li>用户授权网站访问用户信息<ul>
<li>资源拥有者扫描二维码，表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面（让你确认登录）</li>
<li>询问用户是否授权目标网站访问自己在微信的用户信息，用户点击（确认登录）表示同意授权，微信认证服务器会颁发一个授权码给目标网站</li>
<li>只有资源拥有者同意，微信才允许目标网站访问资源</li>
</ul>
</li>
<li>目标网站获取到授权码</li>
<li>携带授权码请求微信认证服务器，申请令牌（此交互过程用户看不到）</li>
<li>微信认证服务器想目标网站响应令牌（此交互过程用户看不到）</li>
<li>目标网站携带令牌请求微信服务器获取用户的基本信息</li>
<li>资源服务器返回受保护资源，即用户信息</li>
<li>目标网站接收到用户信息，此时用户在目标网站登录成功</li>
</ul>
</li>
<li><p>OAuth2.0认证流程</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118172128265.png" alt="image-20240118172128265"></p>
<ul>
<li><code>A</code>表示：客户端请求资源拥有者授权</li>
<li><code>B</code>表示：资源拥有者授权客户端，即用户授权目标网站访问自己的用户信息</li>
<li><code>C</code>表示：目标网站携带授权码请求认证</li>
<li><code>D</code>表示：认证通过，颁发令牌</li>
<li><code>E</code>表示：目标网站携带令牌请求资源服务器，获取资源</li>
<li><code>F</code>表示：资源服务器校验令牌通过后，提供受保护的资源</li>
</ul>
</li>
<li><p>OAuth 2.0包括以下角色</p>
<ol>
<li><p><code>客户端</code>：本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，例如：手机客户端、浏览器等</p>
</li>
<li><p><code>资源拥有者</code>：通常为用户，也可以是应用程序，即该资源的拥有者</p>
</li>
<li><p><code>授权服务器（认证服务器）</code>：认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌</p>
</li>
<li><p><code>资源服务器</code>：存储资源的服务器</p>
</li>
</ol>
</li>
<li><p>在本项目的应用</p>
<ul>
<li>学成在线访问第三方系统的资源<ul>
<li>本项目要接入微信扫码登录，所以本项目要是用OAuth2协议访问微信中的用户信息</li>
</ul>
</li>
<li>外部系统访问学成在线的资源<ul>
<li>同样当第三方系统想要访问学成在线网站的资源，也可以基于OAuth2协议来访问用户信息</li>
</ul>
</li>
<li>学成在线前端（客户端）访问学成在线微服务的资源<ul>
<li>本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议</li>
</ul>
</li>
</ul>
</li>
<li><p>四种模式</p>
<ul>
<li><p>授权码模式（微信扫码）</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118172500362.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118172500362.png</a>“ alt=”image-20240118172500362” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>密码模式（也应用的多）</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118172522851.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240118172522851.png</a>“ alt=”image-20240118172522851” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>简化模式</p>
</li>
<li><p>客户端模式</p>
</li>
</ul>
</li>
</ul>
<h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4><ul>
<li><p>普通令牌问题</p>
<ul>
<li><p>客户端申请到令牌，接下来客户端携带令牌去访问资源，到资源服务器会校验令牌的合法性。<br>资源服务器如何校验令牌的合法性？这里以OAuth2的密码模式为例进行说明</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119094718731.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119094718731.png</a>“ alt=”image-20240119094718731” style=”zoom:50%;” /&gt;</p>
</li>
<li><p>问题：校验令牌需要远程请求认证服务，客户端每次访问都会远程校验，<strong>执行性能低</strong></p>
</li>
<li><p>改进：</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119094817784.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119094817784.png</a>“ alt=”image-20240119094817784” style=”zoom:50%;” /&gt;</p>
</li>
<li><p>如何解决上面的问题，实现资源服务自行校验令牌呢？</p>
<ul>
<li>令牌采用JWT格式即可解决上面的问题，用户认证后会得到一个JWT令牌，JWT令牌中已经包括了用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次都请求认证服务完成授权</li>
</ul>
</li>
</ul>
</li>
<li><p>Json Web Token（JWT）是一种使用Json格式传递数据的网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简介的、自包含的协议格式，用于在通信双方传递Json对象，传递的对象经过数字签名可以被验证和信任，它可以是应用HMAC算法或使用RSA的公钥/私钥来签名，防止内容篡改<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<ul>
<li>使用JWT可以实现无状态认证。什么是<code>无状态认证</code>？</li>
<li>传统的基于Session的方式是<code>有状态认证</code>，用户登录成功，将用户的身份信息存储在服务端，这样加大了服务端的存储压力，并且这种方式不适合在分布式系统中应用<ul>
<li>当用户访问应用服务，每个应用服务都会去服务器查看Session信息，如果没有Session，则认证用户没有登录，此时会重新认证，而解决这个问题的颁发是Session复制黏贴</li>
</ul>
</li>
<li>如果是基于令牌技术，用户，用户将令牌存储在客户端，去访问应用服务时携带令牌去访问，服务端从JWT解析出用户信息，这个过程就是无状态认证</li>
</ul>
</li>
</ul>
<ul>
<li>JWT令牌的优点<ul>
<li>JWT基于JSON，非常方便解析</li>
<li>可以在令牌中自定义丰富的内容，易扩展</li>
<li>通过非对称加密算法及数字签名技术，JWT防篡改，安全性高</li>
<li>资源服务使用JWT可不依赖认证服务即可完成授权</li>
</ul>
</li>
<li><p>缺点</p>
<ul>
<li>JWT令牌较长，占存储空间比较大</li>
</ul>
</li>
<li><p>JWT内容：有三部分，每部分中间使用点（.）分隔，例如xxxx.yyyyyy.zzzzzzz</p>
<ul>
<li><p>第一部分Header：头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC、SHA256或RSA），一个例子如下</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"alg"</span><span class="punctuation">:</span> <span class="string">"HS256"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"typ"</span><span class="punctuation">:</span> <span class="string">"JWT"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>将上面的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分</li>
</ul>
</li>
<li><p>第二部分Payload：内容也是一个Json对象</p>
<ul>
<li><p>它是存放有效信息的地方，它可以存放JWT提供的现成字段，如iss（签发者）、exp（过期时间戳）、sub（面向的用户）等，也可以自定义字段</p>
</li>
<li><p>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容</p>
</li>
<li><p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"sub"</span><span class="punctuation">:</span> <span class="string">"1234567890"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"456"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"admin"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>第三部分：Sugbature：第三部分是签名，此部分用于防止JWT内容被篡改。</p>
<ul>
<li><p>这个部分使用Base64Url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用Header中声明的签名算法进行签名</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">    base64UrlEncode(header) + <span class="string">"."</span> +</span><br><span class="line">    base64UrlEncode(payload)<span class="punctuation">,</span></span><br><span class="line">    secret)</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>为什么JWT可以防止篡改？</p>
<ul>
<li>第三部分使用签名算法对第一部分和第二部分的内容进行签名，常见的签名算法是HS526，常见的还有MD5、SHA等，签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的，如果第三方更改了内容，那么服务器验证前面就会失败，要想保证签名正确，必须保证内容、密钥与签名前一致</li>
</ul>
</blockquote>
</li>
<li><p>JWT认证过程</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119095547079.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119095547079.png</a>“ alt=”image-20240119095547079” style=”zoom:67%;” /&gt;</p>
<ul>
<li>从上图中可以看出，认证服务和资源服务使用相同的密钥，这叫对称加密，对称加密效率高，如果一旦密钥泄露可以伪造JWT令牌</li>
<li>JWT还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密、解密，非对称加密效率低，但相比较于对称加密更加安全</li>
</ul>
</li>
</ul>
<h4 id="网关鉴定"><a href="#网关鉴定" class="headerlink" title="网关鉴定"></a>网关鉴定</h4><ul>
<li><p>加上网关后的过程</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119105355848.png" alt="image-20240119105355848"></p>
</li>
<li><p>所有访问微服务的请求都要经过网关，在网关进行用户身份的认证，可以将很多非法的请求拦截到微服务以外，这叫做<strong>网关鉴权</strong></p>
</li>
<li><p>网关鉴权的职责</p>
<ul>
<li>网站白名单维护：针对不用认证的URL全部放行</li>
<li><p>校验JWT的合法性：除了白名单剩下的就是需要认证的请求，网关需要验证JWT的合法性，JWT合法则说明用户身份合法，否则说明身份不合法，拒绝继续访问</p>
</li>
<li><p>注意：<strong>网关不负责授权</strong>，对请求的授权操作在各个微服务进行，因为微服务最清楚用户有哪些权限访问哪些接口</p>
</li>
</ul>
</li>
<li><p>步骤</p>
<ul>
<li>在网关服务中引入依赖</li>
<li>网关过滤器</li>
<li>配置白名单</li>
<li>在微服务中放行所有请求</li>
</ul>
</li>
</ul>
<h3 id="5-2-用户认证"><a href="#5-2-用户认证" class="headerlink" title="5.2 用户认证"></a>5.2 用户认证</h3><ul>
<li><p>到目前为止，我们的用户认证流程如下</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119110656791.png" alt="image-20240119110656791"></p>
</li>
<li><p>自定义<code>UserDetailsImpl implements UserDetailsService</code>读取数据库用户信息</p>
<ul>
<li>重写<code>loadUserByUsername()</code>方法</li>
</ul>
</li>
<li><p>扩展用户身份信息，在JWT令牌中存储用户的昵称、头像、QQ等信息</p>
<ul>
<li>说明：在认证阶段DaoAuthenticationProvider会调用UserDetailsService查询用户的信息，这里是可以获取到齐全的用户信息，由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路</li>
<li>方法一：自定义<code>UserDetails</code> ，让它包括更多的自定义属性</li>
<li>方法二：扩展username的内容，例如存入Json数据作为username的内容</li>
</ul>
</li>
<li><p>资源服务获取用户身份</p>
<ul>
<li>根据返回的json内容转为一个java对象</li>
<li>在content-api中定义一个工具类来处理</li>
</ul>
</li>
</ul>
<h3 id="5-3-统一认证服务"><a href="#5-3-统一认证服务" class="headerlink" title="5.3 统一认证服务"></a>5.3 统一认证服务</h3><blockquote>
<p>基于当前研究的Spring Security认证流程如何支持多样化的认证方案呢？</p>
<ol>
<li>支持账号和密码认证<ul>
<li>采用OAuth2协议的密码模式即可实现</li>
</ul>
</li>
<li>支持手机号加验证码认证<ul>
<li>用户认证提交的是手机号和验证码，并不是账号和密码</li>
</ul>
</li>
<li>微信扫码认证<ul>
<li>基于OAuth2协议与微信交互，学成在线网站会向微信服务器申请一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过</li>
</ul>
</li>
</ol>
</blockquote>
<ul>
<li><p>而不同的认证提交方式的数据不一样，例如</p>
<ul>
<li>手机加验证码方式：会提交手机号和验证码</li>
<li>账号密码方式：会提交账号、密码、验证码</li>
</ul>
</li>
<li><p>解决：我们可以在<code>loadUserByUsername()</code>方法上做文章，将用户原来提交的账号数据改为提交一个JSON数据，JSON数据可以扩展不同的认证方式所提交的各种参数</p>
</li>
<li><p>步骤</p>
<ul>
<li><p>定义<code>AuthParamsDto</code>来接收认证参数（统一接收参数）</p>
</li>
<li><p>修改<code>UserDetailsImpl</code>的 <code>loadUserByUsername()</code>方法，让它解析接收的字符串为<code>AuthParamsDto</code>对象（之前就只是一个密码）</p>
</li>
<li>继承<code>DaoAuthenticationProvider</code>并重写<code>additionalAuthenticationChecks</code>方法</li>
<li>在<code>WebSecurityConfig</code>中注入</li>
<li>定义<code>AuthService</code>接口，不同的登录方式分别继承这个接口，重写<code>execute</code>方法（<strong>策略模式</strong>）</li>
<li>修改<code>UserDetailsImpl</code>的<code>loadUserByUsername</code>，根据输入参数转换的<code>AuthParamsDto</code>对象的<code>authType</code>方法来获取到spring容器的<code>AuthService</code>继承类的<code>bean</code>，调用<code>bean</code>的<code>execute</code>方法得到<code>XcUserExt</code>对象，随后转为Json返回（主要要把敏感信息置null，比如密码）</li>
</ul>
</li>
<li><p>总结：</p>
<ul>
<li>统一在一个地方登录</li>
<li>统一请求数据/认证参数</li>
<li>统一了认证接口</li>
</ul>
</li>
</ul>
<h3 id="5-4-验证码服务"><a href="#5-4-验证码服务" class="headerlink" title="5.4 验证码服务"></a>5.4 验证码服务</h3><ul>
<li>步骤<ul>
<li>请求生成验证码：<code>POST {{checkcode_host}}/checkcode/pic</code></li>
<li>返回一个json 包含<code>key</code>和<code>aliasing</code>两个字段，key表示验证码的key，aliasing是对应的图片，与此同时将key和对应的验证码字符串存入redis中，其中键就是key，值就是字符串</li>
<li>当用户进行验证码验证的时候，根据key向redis中取出字符串进行对比</li>
</ul>
</li>
</ul>
<h3 id="5-5-账号密码登录完善"><a href="#5-5-账号密码登录完善" class="headerlink" title="5.5 账号密码登录完善"></a>5.5 账号密码登录完善</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119144944164.png" alt="image-20240119144944164"></p>
<ul>
<li>前期准备完成</li>
<li>步骤<ul>
<li>定义远程调用验证码服务的接口</li>
<li>启动类添加开启Feign的注解</li>
<li>完善<code>PasswordAuthServiceImpl</code></li>
</ul>
</li>
</ul>
<h3 id="5-6-微信登录（与第三方接口对接）"><a href="#5-6-微信登录（与第三方接口对接）" class="headerlink" title="5.6 微信登录（与第三方接口对接）"></a>5.6 微信登录（与第三方接口对接）</h3><ul>
<li><p>接口文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</a></p>
</li>
<li><p>整体流程：</p>
<ol>
<li><p>第三方发起微信授权登录请求，微信用户允许授权第三方应用后，微信会拉起应用或重定向到第三方网站，并且带上授权临时票据 code 参数；</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240127154915000.png" alt="image-20240127154915000"></p>
</li>
<li><p>通过 code 参数加上 AppID 和AppSecret等，通过 API 换取access_token(令牌)；</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240127154903134.png" alt="image-20240127154903134"></p>
</li>
<li><p>通过access_token进行接口调用，获取用户基本数据资源或帮助用户实现基本操作。</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240127154843269.png" alt="image-20240127154843269"></p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119151437866.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119151437866.png</a>“ alt=”image-20240119151437866” style=”zoom:67%;” /&gt;</p>
</li>
</ol>
</li>
<li><p>结合本项目流程</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119152008978.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240119152008978.png</a>“ alt=”image-20240119152008978” style=”zoom:67%;” /&gt;</p>
</li>
</ul>
<blockquote>
<p>本项目认证服务需要做哪些事？</p>
<ol>
<li>需要定义接口接收微信下发的授权码</li>
<li>收到授权码调用微信接口申请令牌</li>
<li>申请到令牌后，调用微信获取用户信息</li>
<li>获取用户信息成功，将其写入本项目的用户信息数据库</li>
<li>重定向到浏览器自动登录</li>
</ol>
</blockquote>
<ul>
<li>需要一个内网穿透工具，不然微信服务无法找到本机的认证服务</li>
</ul>
<h3 id="5-7-授权"><a href="#5-7-授权" class="headerlink" title="5.7 授权"></a>5.7 授权</h3><ul>
<li>如何实现授权？业界通常基于RBAC实现授权</li>
</ul>
<h4 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h4><ul>
<li>两种方式<ul>
<li>基于角色的访问控制（Role-Based Access Control）：按角色进行授权<ul>
<li>缺点：当需要修改角色权限时，就需要修改授权相关的代码，系统可扩展性差</li>
</ul>
</li>
<li><strong>基于资源的访问控制</strong>（Resource-Based Access Control）：按资源/权限授权<ul>
<li>系统设计时定义好权限标识，修改角色的权限信息即可完成角色权限</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="资源服务授权流程"><a href="#资源服务授权流程" class="headerlink" title="资源服务授权流程"></a>资源服务授权流程</h4><ul>
<li><p>本项目在资源服务内部进行授权，基于资源的授权方式，因为接口在资源服务，通过在接口处添加授权注解实现授权</p>
</li>
<li><p>配置nginx</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#前端开发服务</span><br><span class="line">upstream uidevserver{</span><br><span class="line">    server 127.0.0.1:8601 weight=10;</span><br><span class="line">} </span><br><span class="line">server {</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  teacher.localhost;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    location / {</span><br><span class="line">        proxy_pass   http://uidevserver;</span><br><span class="line">        proxy_cookie_path / "/; HTTPOnly; SameSite=strict";</span><br><span class="line">        proxy_cookie_domain uidevserver teacher.localhost;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    location /api/ {</span><br><span class="line">        proxy_pass http://gatewayserver/;</span><br><span class="line"></span><br><span class="line">    }   </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>接口中使用：<code>@PreAuthorize("hasAuthority('权限标识符')")</code></p>
</li>
<li><p>原理：在令牌中有一个<code>authorities</code>字段表示用户的权限信息，然后去和<code>@PreAuthorize</code>注解中的权限进行对比，在权限范围则通过，否则拒绝</p>
</li>
</ul>
<h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><ul>
<li>如何给用户分配权限呢？查看数据库中的表结构<ul>
<li><code>xc_user</code>：用户表，存储了系统用户信息</li>
<li><code>xc_user_role</code>：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户拥有<ul>
<li>关系表，用于连接<code>xc_user</code>和<code>xc_role</code></li>
</ul>
</li>
<li><code>xc_role</code>：角色表，存储了系统的角色类型，角色类型包括：学生、老师、管理员、教学管理员、超级管理员</li>
<li><code>xc_permission</code>：角色权限表，一个角色可拥有多个权限，一个权限可被多个角色拥有<ul>
<li>关系表，用于连接<code>xc_role</code>和<code>xc_menu</code>表</li>
</ul>
</li>
<li><code>xc_menu</code>：权限菜单表，里面记录了各种操作的权限code</li>
</ul>
</li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240122154644485.png" alt="image-20240122154644485"></p>
<ul>
<li>如何将用户的权限返回？<ul>
<li>UserDetails构建的时候加入<code>authorities</code>的修饰    </li>
</ul>
</li>
<li>查询用户权限</li>
</ul>
<h3 id="5-8-细粒度授权"><a href="#5-8-细粒度授权" class="headerlink" title="5.8 细粒度授权"></a>5.8 细粒度授权</h3><blockquote>
<p>什么叫细粒度授权？</p>
<ul>
<li>细粒度授权也叫数据范围授权，即不同的用户所拥有的的操作权限相同，但是能够操作的数据范围是不一样的。</li>
<li>例如：用户A和网易的，用户B是字节的，他们都拥有<code>我的课程</code>的权限，但他们查询到的数据是不一样的，因为不能查询别的机构的课程</li>
</ul>
<p>本项目有哪些细粒度授权？</p>
<ul>
<li>我的课程：教学机构只允许查询本机构下的课程信息</li>
<li>我的选课：学生只允许查询自己所选的课</li>
</ul>
<p>如何实现细粒度授权？</p>
<ul>
<li>细粒度授权涉及到不同的业务逻辑，通常在service层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据，或操作不同的数据</li>
</ul>
</blockquote>
<p>实现</p>
<ul>
<li>教学机构在维护课程时，只允许维护本机构的课程，教学机构细粒度授权过程如下<ol>
<li>获取当前登录的用户身份</li>
<li>得到用户所属教育机构的id</li>
<li>查询该教学机构下的课程信息</li>
</ol>
</li>
<li>最终实现了用户只允许查询自己机构的课程信息</li>
<li>在之前的做法，我们是模拟了一个假数据，用的是一个写死的companyId</li>
<li>根据companyId查询课程，流程如下<ol>
<li>教学机构用户登录系统，从用户身份中取出所属机构的id</li>
<li>接口层取出当前登录用户的身份，取出机构id</li>
<li>将机构id传入service方法</li>
<li>service方法将机构id传入dao方法，作为SQL查询参数（where companyId = ${companyId}），最终查询出本机构的课程信息</li>
</ol>
</li>
</ul>
<h2 id="6-选课模块"><a href="#6-选课模块" class="headerlink" title="6 选课模块"></a>6 选课模块</h2><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123091506763.png" alt="image-20240123091506763"></p>
<h3 id="6-1-学生选课"><a href="#6-1-学生选课" class="headerlink" title="6.1 学生选课"></a>6.1 学生选课</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123091707512.png" alt="image-20240123091707512"></p>
<ul>
<li><p>选课信息存入选课记录表</p>
<ul>
<li>如果选的是免费课程，除了要将信息存入选课记录表，同时也要存入我的课程表</li>
<li>如果选的是收费课程，将信息存入选课信息表后，要经过下单、支付成功后，才可以存入我的课程表</li>
</ul>
</li>
<li><p>选课记录表</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123092901604.png" alt="image-20240123092901604"></p>
<ul>
<li>选课类型：免费课程、收费课程</li>
<li>选课状态：选课成功、待支付、选课删除</li>
<li>对于免费课程：课程价格为0，默认有效期为365天，开始服务时间为选课时间，结束服务时间为选课时间加一年后的时间，选课状态为选课成功</li>
<li>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间、选课状态为待支付</li>
<li>收费课程的选课记录需要支付成功后，选课状态为选课成功</li>
</ul>
</li>
<li><p>我的课程表</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123092927497.png" alt="image-20240123092927497"></p>
<ul>
<li>对于免费课程：创建选课记录时，同时向我的课程表添加记录</li>
<li>对于收费课程：创建选课记录后，需要下单支付成功后，自动向我的课程表添加记录</li>
</ul>
</li>
<li><p>具体流程</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123092958882.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123092958882.png</a>“ alt=”image-20240123092958882” style=”zoom:67%;” /&gt;</p>
</li>
</ul>
<h3 id="6-2-下单支付"><a href="#6-2-下单支付" class="headerlink" title="6.2 下单支付"></a>6.2 下单支付</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123091717092.png" alt="image-20240123091717092"></p>
<ul>
<li>流程（红色部分是订单支付模块完成）<ul>
<li>请求学习中心服务创建选课记录</li>
<li>请求订单服务创建商品订单、生成支付二维码</li>
<li>用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单</li>
<li>前端唤起支付客户端，用户输入密码完成支付</li>
<li>第三方支付平台支付完成后，发起支付通知</li>
<li>订单支付服务接收支付通知结果</li>
<li>用户在前端查询支付结果，请求订单支付服务查询支付结果，如果订单服务还没有收到支付结果，则请求学习中心查询支付结果</li>
<li>订单支付服务向学习中心通知支付结果</li>
<li>学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表</li>
</ul>
</li>
</ul>
<h3 id="6-3-支付通知"><a href="#6-3-支付通知" class="headerlink" title="6.3 支付通知"></a>6.3 支付通知</h3><ul>
<li>支付服务通过消息队列将支付消息给学习服务</li>
</ul>
<blockquote>
<p>为什么不用feign？</p>
<ul>
<li>减少耦合</li>
</ul>
</blockquote>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124095859634.png" alt="image-20240124095859634"></p>
<ul>
<li>订单服务作为通用服务，在订单支付成功后，需要将支付结果异步通知给其他微服务<ul>
<li>学习中心服务：对于收费课程，选课需要支付，与订单服务对接完成支付</li>
<li>学习资源服务：对于收费的学习资料，需要购买后才能下载，与订单服务对接完成支付</li>
</ul>
</li>
<li>本项目使用RabbitMQ，可以通过以下几个方面保证消息的可靠性<ol>
<li>生产者确认机制<ul>
<li>发送消息前，使用数据库事务将消息保证到数据库表中</li>
<li>成功发送到交换机，将消息从数据库中删除</li>
</ul>
</li>
<li>MQ持久化<ul>
<li>MQ收到消息会持久化，当MQ重启，即使消息没有消费完，也不会丢失</li>
<li>需要配置交换机持久化、队列持久化、发送消息时设置持久化</li>
</ul>
</li>
<li>消费者确认机制<ul>
<li>消费者消费成功，自动发送ACK，负责重试消费</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="6-4-学生学习"><a href="#6-4-学生学习" class="headerlink" title="6.4 学生学习"></a>6.4 学生学习</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123091726920.png" alt="image-20240123091726920"></p>
<ul>
<li>用户通过课程详情界面点击<code>马上学习</code>，进入视频播放页面进行视频点播</li>
<li>获取视频资源时，进行学习资格校验</li>
<li>拥有学习资格则继续播放视频，不具有学习资格，则引导其去购买、续期等操作</li>
</ul>
<blockquote>
<p>如何判断是否拥有学习资格?</p>
<ul>
<li>首先判断是否为试学视频，如果为试学视频，则可以正常学习</li>
<li>如果为非试学视频，则先判断用户是否登录，如果已经登录则判断是否选课，如果已经选课，且没有过期则可以正常学习</li>
</ul>
</blockquote>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124111308158.png" alt="image-20240124111308158"></p>
<h3 id="6-5-我的课程表"><a href="#6-5-我的课程表" class="headerlink" title="6.5 我的课程表"></a>6.5 我的课程表</h3><h3 id="6-6-免费课程续期"><a href="#6-6-免费课程续期" class="headerlink" title="6.6 免费课程续期"></a>6.6 免费课程续期</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123091805261.png" alt="image-20240123091805261"></p>
<h2 id="7-支付模块"><a href="#7-支付模块" class="headerlink" title="7 支付模块"></a>7 支付模块</h2><ul>
<li><p>支付宝官方文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105285/">https://opendocs.alipay.com/open/203/105285/</a></p>
</li>
<li><p>配置沙箱环境</p>
</li>
<li><p>接口交互流程</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123142722275.png" alt="image-20240123142722275"></p>
</li>
</ul>
<h3 id="7-1-接口测试"><a href="#7-1-接口测试" class="headerlink" title="7.1 接口测试"></a>7.1 接口测试</h3><p>查文档</p>
<h3 id="7-2-生成二维码"><a href="#7-2-生成二维码" class="headerlink" title="7.2 生成二维码"></a>7.2 生成二维码</h3><p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123162041937.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123162041937.png</a>“ alt=”image-20240123162041937” style=”zoom: 67%;” /&gt;</p>
<ul>
<li>流程<ul>
<li>前端调用学习中心服务的添加选课接口</li>
<li>添加选课成功，请求订单服务生成支付二维码接口</li>
<li>生成二维码接口：创建商品订单、生成支付交易记录、生成二维码</li>
<li>将二维码返回到前端，用户扫码</li>
</ul>
</li>
<li><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123162549494.png" alt="image-20240123162549494"><ul>
<li>其中支付记录表的pay_no才是传给支付平台的订单号</li>
</ul>
</li>
</ul>
<blockquote>
<p>为什么创建支付交易记录？</p>
<ul>
<li><p>在请求微信或支付宝下单接口时，需要传入<code>商品订单号</code>，在与第三方交付平台对接时发现，当用户支付失败或因为其他原因导致该订单没有支付成功，此时再次调用第三方支付平台的下单接口就会报错<code>订单号已存在</code>。</p>
</li>
<li><p>但如果我们此时传入一个新的订单号就可以解决问题，但是商品订单已经创建，因此没有支付成功重新创建一个新订单是不合理的</p>
</li>
<li><p>解决以上问题的方案是</p>
<ol>
<li><p>用户每次发起都创建一个新的支付交易记录，此交易记录与商品订单关联</p>
</li>
<li><p>将支付交易记录的流水号传给第三方支付系统的下单接口，这样即使没有支付成功，也不会出现上面的问题</p>
</li>
<li><p>判断订单支付状态，提醒用户不要重复支付</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240123165044814.png" alt="image-20240123165044814"></p>
</li>
</ol>
</li>
</ul>
</blockquote>
<h2 id="8-项目部署"><a href="#8-项目部署" class="headerlink" title="8 项目部署"></a>8 项目部署</h2><ul>
<li><p><strong>DevOps</strong>（Development 和 Operations）</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124154335446.png" alt="image-20240124154335446"></p>
</li>
<li><p><strong>CI/CD</strong>包含两个CI和两个CD</p>
<ul>
<li>持续集成</li>
<li>持续交付</li>
<li>持续部署</li>
</ul>
</li>
<li><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124155500369.png" alt="image-20240124155500369"></p>
<ul>
<li>Kubernetes：k8s（中间有8个字母）</li>
<li>Jenkins</li>
</ul>
</li>
<li><p>环境准备</p>
<ul>
<li><p>Centos7虚拟机，安装docker、jdk、maven，通过docker容器安装jenkins、docker私服软件及其他软件</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124160024156.png" alt="image-20240124160024156"></p>
</li>
</ul>
</li>
</ul>
<h3 id="手动部署"><a href="#手动部署" class="headerlink" title="手动部署"></a>手动部署</h3><ul>
<li><p>项目打包</p>
<ul>
<li><p>在parent项目的pom中聚合各个模块</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124161607063.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124161607063.png</a>“ alt=”image-20240124161607063” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>这样做的好处是之后编译的时候maven会自动识别依赖关系然后自动确定各个模块的打包顺序</p>
</li>
</ul>
</li>
<li><p>配置打包插件</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124161810725.png" alt="image-20240124161810725"></p>
<ul>
<li><p>在要打可执行jar包的工程中配置该插件</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124162321041.png" alt="image-20240124162321041"></p>
</li>
<li><p>说明</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124162310357.png" alt="image-20240124162310357"></p>
</li>
</ul>
</li>
<li><p>package生成jar包，使用<code>java -jar</code>可以正常启动运行</p>
</li>
<li><p>然后传到linux中，并在文件夹中创建dockerfile文件用于构建镜像</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240124164245696.png" alt="image-20240124164245696"></p>
</li>
<li><p>使用docker build创建镜像</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t checkcode:<span class="number">1.0</span> .</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>-t checkcode:1.0</code>是指构建后的镜像名称</li>
<li>最后的 <code>.</code> 表示dockerfile文件在当前目录</li>
</ul>
</li>
<li><p>创建并启动容器</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> --name xuecheng-plus-checkcode -p 63075:63075 -idt checkcode:1.0</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>查看运行日志</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f xuecheng-plus-checkcode</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="自动部署Jenkins"><a href="#自动部署Jenkins" class="headerlink" title="自动部署Jenkins"></a>自动部署Jenkins</h3><ul>
<li>修改需要启动的服务的pom文件</li>
<li>代码提交到git</li>
</ul>
<h2 id="9-项目优化"><a href="#9-项目优化" class="headerlink" title="9 项目优化"></a>9 项目优化</h2><ul>
<li><p>压力测试</p>
<ul>
<li><p>主要是测试需要直接查询数据库的地方，比如课程信息中的视频就是直接查数据库来的</p>
</li>
<li><p>吞吐量(TBS)：系统每秒可以处理的事务数</p>
</li>
<li>响应时间：指客户端请求数据，请求从系统到客户端的时间</li>
<li>每秒查询数(QPS)：一秒可以请求该接口查询商品信息的次数</li>
<li>错误率</li>
</ul>
</li>
<li><p>Jmeter软件</p>
</li>
</ul>
<h3 id="9-1-redis缓存优化"><a href="#9-1-redis缓存优化" class="headerlink" title="9.1 redis缓存优化"></a>9.1 redis缓存优化</h3><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125104439596.png" alt="image-20240125104439596"></p>
<ul>
<li><p>实现</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125104730079.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125104730079.png</a>“ alt=”image-20240125104730079” style=”zoom:67%;” /&gt;</p>
</li>
<li><p>缓存穿透问题</p>
<blockquote>
<p>使用缓存后，码的性能有了很大的提升，但是控制台还是打出了很多从数据库查询的日志，明明已经判断了如果缓存存在，课程信息就从缓存中查询，那为什么还有这么多从数据库查询的请求呢？</p>
<ul>
<li>因为并发数很高，很多线程会同时到达查询数据库代码处去执行</li>
<li>如果存在恶意攻击的可能，大量并发去查询一个不存在的课程信息会出现什么问题呢？</li>
</ul>
</blockquote>
<ul>
<li>大量并发去访问一个数据库不存在的数据，由于缓存中没有该数据，就会导致大量并发查询数据库，这个现象叫<strong>缓存穿透</strong></li>
<li>缓存穿透可以造成数据库瞬间压力过大，连接数等资源耗尽，最终数据库拒绝连接，不可用</li>
</ul>
</li>
<li><p>缓存穿透解决</p>
<ul>
<li>方式一：对请求增加校验极致</li>
<li>方式二：使用布隆过滤器</li>
<li>方式三：缓存空值或特殊值<ul>
<li>请求通过了第一步校验，查询数据库得到的数据不存在，此时我们仍然去缓存数据，缓存一个空值或一个特殊值的数据</li>
<li>注意：如果缓存了空值或特殊值，要设置一个短暂的过期时间</li>
</ul>
</li>
</ul>
</li>
<li><p>缓存雪崩</p>
<ul>
<li>缓存雪崩是缓存中大量key失效后，当高并发到来时导致大量请求到数据库，瞬间耗尽数据库资源，导致数据库无法使用</li>
<li>造成缓存雪崩问题的原因是大量key拥有了相同的过期时间<ul>
<li>例如：对课程信息设置缓存过期时间为10分钟，当大量请求同时查询大量课程信息时，由于大量课程拥有相同的过期时间，所以大量课程的缓存信息也会同时失效，出现缓存雪崩问题</li>
</ul>
</li>
</ul>
</li>
<li><p>解决缓存雪崩</p>
<ul>
<li><p>方法一：使用同步锁控制数据库的线程（性能不高）</p>
<ul>
<li><p>使用同步锁控制查询数据库的线程，只允许有一个线程去查询数据库，查询得到数据后存入缓存</p>
<p>&lt;img src=(<a target="_blank" rel="noopener" href="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125111225625.png">https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125111225625.png</a>“ alt=”image-20240125111225625” style=”zoom:67%;” /&gt;</p>
</li>
</ul>
</li>
<li><p>方式二：对同一类型信息的key设置不同的过期时间</p>
<ul>
<li>通常对一类信息的key设置的过期时间是相同的，这里可以在原有的固定时间基础上，加上一个随机时间，从而使他们的过期时间不相同</li>
</ul>
</li>
<li><p>方式三：缓存预热</p>
<ul>
<li>不用等到请求到来再去查询数据库存入缓存，可以写一个定时任务，提前将数据存入缓存。使用缓存预热机制，通常有专门的后台程序去将数据库的数据同步到缓存中</li>
</ul>
</li>
</ul>
</li>
<li><p>缓存击穿</p>
<ul>
<li>缓存击穿是指大量并发访问同一个热点数据，当单例数据失效后，同时去请求数据库，瞬间耗尽数据库资源，导致数据库无法使用<ul>
<li>例如：某手机新品发布，此时手机数据存在缓存中，如果在秒杀的时候，缓存刚好失效，那么此时就会有大量请求直接访问数据库</li>
</ul>
</li>
</ul>
</li>
<li><p>如何解决</p>
<ul>
<li><p>方式一：使用同步锁控制查询数据库的线程，只允许有一个线程去查询数据库，查询得到的数据存入缓存</p>
</li>
<li><p>方式二：热点数据不过期</p>
<ul>
<li>可以由后台程序提前将热点数据加入缓存，缓存时间设置不过期，由后台程序做好缓存同步</li>
</ul>
</li>
</ul>
</li>
<li><p>总结：</p>
<ul>
<li><strong>缓存穿透</strong><ul>
<li>去访问一个<strong>数据库不存在</strong>的数据，无法将数据进行缓存，导致直接查询数据库，当并发较大时，就会对数据库产生压力。</li>
<li>缓存穿透可以造成数据库压力增大，连接数等资源用完，最终数据库拒绝连接不可用</li>
<li>解决方案<ol>
<li>缓存一个null值</li>
<li>布隆过滤器</li>
</ol>
</li>
</ul>
</li>
<li><strong>缓存雪崩</strong><ul>
<li>缓存中<strong>大量key失效</strong>后，当高并发到来时，导致大量请求到数据库，瞬间耗尽数据库资源，导致数据库无法使用</li>
<li>造成缓存雪崩问题的原因是大量key拥有了相同的过期时间</li>
<li>解决方案：<ol>
<li>使用同步锁控制</li>
<li>设置不同的过期时间，例如：使用固定数+随机数作为过期时间</li>
</ol>
</li>
</ul>
</li>
<li><strong>缓存击穿</strong><ul>
<li>大量并发<strong>访问同一个热点数据</strong>，当热点数据失效后，同时去请求数据库，瞬间耗尽数据库资源，导致数据库无法使用</li>
<li>解决方案<ol>
<li>使用同步锁控制</li>
<li>设置key永不过期</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="9-2-分布式锁"><a href="#9-2-分布式锁" class="headerlink" title="9.2 分布式锁"></a>9.2 分布式锁</h3><ul>
<li>本地锁的问题<ul>
<li>上面的程序中使用了同步锁来解决缓存击穿、缓存雪崩的问题，保证同一个key过期后，只会查询一次数据库，但如果将同步锁的程序，分布式部署在多个jvm上，则无法保证同一个key只会查询一次数据库</li>
</ul>
</li>
</ul>
<blockquote>
<p>什么是分布式锁?</p>
<p>本地锁只能控制所在JVM中的线程同步执行，现在要实现分布式环境下所有虚拟机中的线程去同步执行，就需要让多个JVM使用同一把锁，JVM可以分布式部署，锁也可以分布式部署</p>
<ul>
<li>该锁不属于某个虚拟机，而是分布式部署，由多个虚拟机共享，这种锁叫<strong>分布式锁</strong></li>
</ul>
</blockquote>
<ul>
<li><p>分布式锁的实现方案</p>
<ul>
<li>基于数据库实现分布式锁<ul>
<li>利用数据库主键唯一的特性，或利用数据库唯一索引的特点，多个线程同时去插入相同的记录，谁插入成功谁就抢到锁</li>
</ul>
</li>
<li>基于Redis实现分布式锁<ul>
<li>Redis提供了分布式锁的实现方案，例如：SETNX、Redisson等</li>
<li>拿SETNX举例，SETNX是set一个不存在的key（set if not exists），多个线程去设置同一个key，只会有一个线程设置成功，设置成功的线程拿到锁</li>
</ul>
</li>
<li>使用zookeeper实现<ul>
<li>zookeeper是一个分布式协调事务，主要解决分布式程序之间的同步问题</li>
<li>zookeeper的结构类似文件目录，多线程向zookeeper创建一个子目录（节点）只会有一个创建成功，可以利用此特点实现分布式锁，谁创建该节点成功，谁就获得锁</li>
</ul>
</li>
</ul>
</li>
<li><p>SETNX实现分布式锁</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125112747380.png" alt="image-20240125112747380"></p>
<ul>
<li><p>如何释放锁</p>
<ol>
<li><p>key到期自动释放</p>
<ul>
<li>因为锁设置了过期时间，key到期会自动释放，但是会存在一个问题：查询数据库时，还没操作完，key就到期了</li>
<li>由于key到期了，就会导致其他线程也拿到了锁，最终重复查询数据库，执行了重复的业务操作</li>
<li>怎么解决这个问题？可以将key的到期时间设置的长一些，足以完成查询数据库并设置缓存等相关操作。但是这个效率会低一些，而且到期时间也不好把握</li>
</ul>
</li>
<li><p>手动删除锁</p>
<ul>
<li><p>如果是采用手动删除锁，可能和key到期自动删除有冲突，造成删除了别人的锁</p>
</li>
<li><p>例如：查询数据库等业务还没执行完，此时key过期了，别的线程又拿到锁进来了，当上一个线程执行完查询数据库业务之后，手动删除锁，把新进来的线程的锁给删了</p>
</li>
<li><p>要解决这个问题，可以在删除锁之前，判断这个锁是不是自己的，伪代码如下</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125112949438.png" alt="image-20240125112949438"></p>
<ul>
<li>上述代码10~13行非原子性，也会导致删除其他线程的锁</li>
<li>想实现原子性，需要让redis去执行Lua脚本的方式去实现，这样就具有原子性，但是过期时间的值设置还存在不精准的问题</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li><p>Redisson实现分布式锁(碾压setnx)</p>
<ul>
<li><p>Redisson相比SETNX实现分布式锁要简单的多，其工作原理如下</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125115024195.png" alt="image-20240125115024195"></p>
</li>
<li><p>加锁机制</p>
<ul>
<li>线程去获取锁，获取成功：执行lua脚本，保存数据到redis</li>
<li>线程去获取锁，获取失败：一致通过while循环常事获取锁，获取成功后，执行lua脚本，保存数据到redis</li>
</ul>
</li>
<li>WatchDog自动延期<ul>
<li>第一种情况：在一个分布式环境下，假如一个线程获得锁后，突然服务器宕机了，那么这个时候在一定时间后这个锁会自动释放，你也可以设置锁的有效时间(当不设置默认30秒时），这样的目的主要是防止死锁的发生</li>
<li>第二种情况：线程A业务还没有执行完，时间就过了，线程A 还想持有锁的话，就会启动一个watch dog后台线程，不断的延长锁key的生存时间。</li>
</ul>
</li>
<li>Lua脚本保证原子性操作<ul>
<li>主要是如果你的业务逻辑复杂的话，通过封装在lua脚本中发送给redis，而且redis是单线程的，这样就保证这段复杂业务逻辑执行的原子性</li>
</ul>
</li>
<li>具体使用RLock操作分布式锁，RLock继承了JDK的Lock接口，所以他有Lock接口的所有特性，例如：lock、unlock、tryLock等特性，同时它还有很多新特性：强制锁释放、带有效期的锁</li>
</ul>
</li>
</ul>
<h2 id="10-项目总结"><a href="#10-项目总结" class="headerlink" title="10 项目总结"></a>10 项目总结</h2><h3 id="10-1-项目开发技术点"><a href="#10-1-项目开发技术点" class="headerlink" title="10.1 项目开发技术点"></a>10.1 项目开发技术点</h3><h4 id="1-接口开发"><a href="#1-接口开发" class="headerlink" title="1 接口开发"></a>1 接口开发</h4><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122018593.png" alt="image-20240125122018593"></p>
<h4 id="2-异常处理"><a href="#2-异常处理" class="headerlink" title="2 异常处理"></a>2 异常处理</h4><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122006876.png" alt="image-20240125122006876"></p>
<h4 id="3-前后端联调"><a href="#3-前后端联调" class="headerlink" title="3 前后端联调"></a>3 前后端联调</h4><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122048035.png" alt="image-20240125122048035"></p>
<h4 id="4-解决接口跨域问题"><a href="#4-解决接口跨域问题" class="headerlink" title="4 解决接口跨域问题"></a>4 解决接口跨域问题</h4><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122201913.png" alt="image-20240125122201913"></p>
<ul>
<li><p>解决</p>
<ul>
<li><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122215575.png" alt="image-20240125122215575"></p>
</li>
<li><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122229930.png" alt="image-20240125122229930"></p>
</li>
<li><p>nginx代理</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122359139.png" alt="image-20240125122359139"></p>
</li>
</ul>
</li>
</ul>
<h4 id="5-微服务之间的接口调用"><a href="#5-微服务之间的接口调用" class="headerlink" title="5 微服务之间的接口调用"></a>5 微服务之间的接口调用</h4><p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122422531.png" alt="image-20240125122422531"></p>
<ul>
<li><p>熔断降级</p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122435089.png" alt="image-20240125122435089"></p>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122442244.png" alt="image-20240125122442244"></p>
<h4 id="6-微服务雪崩"><a href="#6-微服务雪崩" class="headerlink" title="6 微服务雪崩"></a>6 微服务雪崩</h4></li>
</ul>
<p><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/学成在线.assets/image-20240125122513252.png" alt="image-20240125122513252"></p>
<ul>
<li>解决<ul>
<li>熔断</li>
<li>降级</li>
<li>限流</li>
</ul>
</li>
</ul>
<h3 id="10-2-模块"><a href="#10-2-模块" class="headerlink" title="10.2 模块"></a>10.2 模块</h3><h4 id="1-内容管理"><a href="#1-内容管理" class="headerlink" title="1 内容管理"></a>1 内容管理</h4><ul>
<li>流程控制</li>
<li>课程审核</li>
<li>课程发布分布式事务方案</li>
<li>课程发布任务调度方案</li>
<li>页面静态化方案</li>
<li>课程搜索方案</li>
</ul>
<h4 id="2-媒资管理"><a href="#2-媒资管理" class="headerlink" title="2 媒资管理"></a>2 媒资管理</h4><ul>
<li>断点续传</li>
<li>任务调度视频处理流程</li>
<li>文件服务访问方案</li>
</ul>
<h4 id="3-认证授权"><a href="#3-认证授权" class="headerlink" title="3 认证授权"></a>3 认证授权</h4><ul>
<li>认证流程</li>
<li>网关统一鉴权</li>
<li>OAuth2</li>
<li>微信扫码流程</li>
<li>授权相关数据模型</li>
<li>验证码校验流程</li>
<li>JWT令牌</li>
<li>spring security工作原理<ul>
<li><code>UserDetails</code>和<code>DaoAuthentication</code></li>
</ul>
</li>
</ul>
<h4 id="4-选课学习"><a href="#4-选课学习" class="headerlink" title="4 选课学习"></a>4 选课学习</h4><ul>
<li>选课流程</li>
<li>在线学习流程</li>
<li>免费课程续期流程</li>
</ul>
<h4 id="5-订单支付"><a href="#5-订单支付" class="headerlink" title="5 订单支付"></a>5 订单支付</h4><ul>
<li>支付流程</li>
<li>生成二维码执行流程</li>
<li>用户扫码支付流程</li>
<li>支付结果通知流程</li>
<li>支付结果通知分布式事务</li>
</ul>
<link rel="stylesheet" href="https://cdn1.tianli0.top/gh/zhheo/Post-Abstract-AI@0.15.2/tianli_gpt.css">

<script>
let tianliGPT_postSelector = '#post #article-container';
let tianliGPT_key = 'c9b7741d290063ab872e';
</script>
<script src="https://cdn1.tianli0.top/gh/zhheo/Post-Abstract-AI@0.15.2/tianli_gpt.js"></script>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://yileman.github.io">myl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://yileman.github.io/posts/50254.html">http://yileman.github.io/posts/50254.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yileman.github.io" target="_blank">myl's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover17.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/17374.html" title="JVM"><img class="cover" src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JVM</div></div></a></div><div class="next-post pull-right"><a href="/posts/21962.html" title="苍穹外卖"><img class="cover" src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover16.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">苍穹外卖</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/57008.html" title="瑞吉外卖"><img class="cover" src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover11.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-19</div><div class="title">瑞吉外卖</div></div></a></div><div><a href="/posts/62391.html" title="黑马头条"><img class="cover" src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover13.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-14</div><div class="title">黑马头条</div></div></a></div><div><a href="/posts/21962.html" title="苍穹外卖"><img class="cover" src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/TyporaImg/cover/article_cover16.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-05</div><div class="title">苍穹外卖</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://myl-mdimg.oss-cn-beijing.aliyuncs.com/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">myl</div><div class="author-info__description">后端学习</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yileman"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">写写记记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF"><span class="toc-number">1.</span> <span class="toc-text">学成在线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-%E6%80%BB%E7%BB%93"><span class="toc-number">1.0.1.</span> <span class="toc-text">0 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">1 异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BC%A0%E5%85%A5%E6%95%B0%E6%8D%AE%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%E6%96%B9%E6%B3%95"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">2 传入数据判断是否为空方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-controller%E4%B8%8E%E5%89%8D%E7%AB%AF%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">3 controller与前端的数据传递</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%A0%91%E5%BD%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.0.1.4.</span> <span class="toc-text">4 树形查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E8%A7%86%E9%A2%91%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.0.1.5.</span> <span class="toc-text">5 视频分块上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-Transactional"><span class="toc-number">1.0.1.6.</span> <span class="toc-text">6 @Transactional</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-freemarker"><span class="toc-number">1.0.1.7.</span> <span class="toc-text">7 freemarker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-xxj-job"><span class="toc-number">1.0.1.8.</span> <span class="toc-text">8 xxj-job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-ES"><span class="toc-number">1.0.1.9.</span> <span class="toc-text">9 ES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-Spring-Security"><span class="toc-number">1.0.1.10.</span> <span class="toc-text">10 Spring Security</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">1.0.1.11.</span> <span class="toc-text">11 验证码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-RabbitMQ"><span class="toc-number">1.0.1.12.</span> <span class="toc-text">12 RabbitMQ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%9D%91"><span class="toc-number">1.1.</span> <span class="toc-text">0 坑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-StringUtils"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">1 StringUtils</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">2 跨域请求问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BC%80%E7%83%AD%E7%82%B9%E4%BC%9A%E5%8D%A0%E7%94%A8%E7%AB%AF%E5%8F%A3%EF%BC%81"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">3 开热点会占用端口！</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-maven-3-6-1"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">4 maven 3.6.1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-nginx"><span class="toc-number">1.1.0.5.</span> <span class="toc-text">5 nginx</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#1-nacos"><span class="toc-number">1.2.</span> <span class="toc-text">1 nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0nacos%E4%B8%8A%E6%8A%A5%E6%9C%8D%E5%8A%A1%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.2.</span> <span class="toc-text">实现nacos上报服务步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">1.2.3.</span> <span class="toc-text">实现nacos配置中心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.</span> <span class="toc-text">2 分布式文件系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">3 媒资管理服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%EF%BC%88MinIO%EF%BC%89"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 上传图片（MinIO）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%EF%BC%88%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%EF%BC%89"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 上传视频（断点续传）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81%EF%BC%88XXL-JOB%EF%BC%89"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 视频转码（XXL-JOB）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">分布式任务处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XXL-Job"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">XXL-Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E9%97%A8%E6%88%B7%E7%BD%91%E7%AB%99"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">部署门户网站</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%8F%8A%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">文件服务及视频播放</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5nginx"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">加入nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9host"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">修改host</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99freemarker%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.4.3.7.</span> <span class="toc-text">编写freemarker模板</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%AF%BE%E7%A8%8B%E5%AE%A1%E6%A0%B8"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.2 课程审核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.3 课程发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">分布式事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">课程发布</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86SDK"><span class="toc-number">1.4.5.3.</span> <span class="toc-text">消息处理SDK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">1.4.5.4.</span> <span class="toc-text">页面静态化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#feign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">1.4.5.5.</span> <span class="toc-text">feign远程调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">1.4.5.6.</span> <span class="toc-text">熔断降级</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E8%AF%BE%E7%A8%8B%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.6.</span> <span class="toc-text">4.4 课程搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#es"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">es</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E4%BF%A1%E6%81%AF%E7%B4%A2%E5%BC%95%E5%90%8C%E6%AD%A5"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">课程信息索引同步</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97"><span class="toc-number">1.5.</span> <span class="toc-text">5 认证授权模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%87%86%E5%A4%87"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-Security%E8%AE%A4%E8%AF%81"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">Spring Security认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OAuth2%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">OAuth2协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JWT"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">JWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E9%89%B4%E5%AE%9A"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">网关鉴定</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 用户认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 统一认证服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E9%AA%8C%E8%AF%81%E7%A0%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 验证码服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E5%AE%8C%E5%96%84"><span class="toc-number">1.5.5.</span> <span class="toc-text">5.5 账号密码登录完善</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%EF%BC%88%E4%B8%8E%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%8E%A5%EF%BC%89"><span class="toc-number">1.5.6.</span> <span class="toc-text">5.6 微信登录（与第三方接口对接）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-%E6%8E%88%E6%9D%83"><span class="toc-number">1.5.7.</span> <span class="toc-text">5.7 授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RBAC"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">RBAC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">资源服务授权流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.7.3.</span> <span class="toc-text">数据模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%88%E6%9D%83"><span class="toc-number">1.5.8.</span> <span class="toc-text">5.8 细粒度授权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%80%89%E8%AF%BE%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.</span> <span class="toc-text">6 选课模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%AD%A6%E7%94%9F%E9%80%89%E8%AF%BE"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 学生选课</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E4%B8%8B%E5%8D%95%E6%94%AF%E4%BB%98"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 下单支付</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 支付通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%AD%A6%E7%94%9F%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 学生学习</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E6%88%91%E7%9A%84%E8%AF%BE%E7%A8%8B%E8%A1%A8"><span class="toc-number">1.6.5.</span> <span class="toc-text">6.5 我的课程表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E5%85%8D%E8%B4%B9%E8%AF%BE%E7%A8%8B%E7%BB%AD%E6%9C%9F"><span class="toc-number">1.6.6.</span> <span class="toc-text">6.6 免费课程续期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%94%AF%E4%BB%98%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.</span> <span class="toc-text">7 支付模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 接口测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 生成二维码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">1.8.</span> <span class="toc-text">8 项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">1.8.1.</span> <span class="toc-text">手动部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Jenkins"><span class="toc-number">1.8.2.</span> <span class="toc-text">自动部署Jenkins</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96"><span class="toc-number">1.9.</span> <span class="toc-text">9 项目优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-redis%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 redis缓存优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 分布式锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93"><span class="toc-number">1.10.</span> <span class="toc-text">10 项目总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%82%B9"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 项目开发技术点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">1 接口开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">2 异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span class="toc-number">1.10.1.3.</span> <span class="toc-text">3 前后端联调</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%A7%A3%E5%86%B3%E6%8E%A5%E5%8F%A3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.1.4.</span> <span class="toc-text">4 解决接口跨域问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E7%9A%84%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="toc-number">1.10.1.5.</span> <span class="toc-text">5 微服务之间的接口调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9"><span class="toc-number">1.10.1.6.</span> <span class="toc-text">6 微服务雪崩</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E6%A8%A1%E5%9D%97"><span class="toc-number">1.10.2.</span> <span class="toc-text">10.2 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">1 内容管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">2 媒资管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">3 认证授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.10.2.4.</span> <span class="toc-text">4 选课学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98"><span class="toc-number">1.10.2.5.</span> <span class="toc-text">5 订单支付</span></a></li></ol></li></ol></li></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2024 - 2025 By myl</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comments.manyile.top/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comments.manyile.top/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.31/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script type="text/javascript" src="https://unpkg.zhimg.com/jquery@latest/dist/jquery.min.js"></script><script data-pjax="" type="text/javascript" src="/js/nav.js"></script><div class="aplayer no-destroy" data-id="2664875269" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted=""></div><script data-pjax="" type="text/javascript" src="/js/randomPaper.js"></script><script type="text/javascript" src="/js/rightMenu.js"></script><script>let tianliGPT_postSelector = '\#post \#article-container';let tianliGPT_key = 'c9b7741d290063ab872e';</script><script src="https://cdn1.tianli0.top/gh/zhheo/Post-Abstract-AI@0.15.2/tianli_gpt.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="iconfont icon-baidu"></i><span>百度搜索</span></a><a class="rightMenu-item" href="javascript:rmf.searchinThisPage();"><i class="fas fa-search"></i><span>站内搜索</span></a><a class="rightMenu-item" href="#post-comment" onclick="rmf.yinyong()"><i class="fa-solid fa-message"></i><span>引用文本评论</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:switchCommentBarrage()"><i class="iconfont icon-danmu"></i><span>开/关评论弹幕</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:fullScreen();"><i class="fas fa-expand"></i><span>进入全屏</span></a></div></div><!-- hexo injector body_end start --><script data-pjax="">function electric_clock_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img id="card-clock-loading" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-clock/clock/images/weather/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading" class="entered loading"></div></div></div></div></div>';
                console.log('已挂载electric_clock')
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='all'|| 'all' ==='all')){

            electric_clock_injector_config()
        } </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.js"></script><script async="" src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>